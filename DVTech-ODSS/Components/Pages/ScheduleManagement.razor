@page "/schedules"
@using DVTech_ODSS.Models
@using DVTech_ODSS.Services
@inject ManpowerService ManpowerService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Schedule Management</PageTitle>

<div class="container-fluid">
    <div class="row mb-3 align-items-center">
        <div class="col">
            <h3 class="mb-0">📅 Schedule Management</h3>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-success me-2" @onclick="ShowQuickScheduleModal">
                ⚡ Quick Schedule
            </button>
            <button type="button" class="btn btn-primary" @onclick="ShowAddForm">
                ➕ Create Schedule
            </button>
        </div>
    </div>

    <!-- View Mode Tabs -->
    <!-- View Mode Tabs -->
    <div class="card shadow-sm mb-3">
        <div class="card-body p-2">
            <div class="btn-group w-100" role="group">
                <button type="button"
                        class="btn @(currentView == "week" ? "btn-primary" : "btn-outline-primary")"
                        @onclick='() => ChangeView("week")'>
                    📅 Week
                </button>
                <button type="button"
                        class="btn @(currentView == "calendar" ? "btn-primary" : "btn-outline-primary")"
                        @onclick='() => ChangeView("calendar")'>
                    🗓️ Month
                </button>
                <button type="button"
                        class="btn @(currentView == "list" ? "btn-primary" : "btn-outline-primary")"
                        @onclick='() => ChangeView("list")'>
                    📋 List
                </button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (showAddForm)
    {
        <!-- Add/Edit Form (Keep existing form) -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0">@(editingSchedule != null ? "Edit Schedule" : "Create New Schedule")</h6>
            </div>
            <div class="card-body p-3">
                <div class="row g-2 mb-2">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold mb-1">Employee *</label>
                        <select class="form-control form-control-sm" @bind="selectedEmployeeId">
                            <option value="0">-- Select Employee --</option>
                            @foreach (var emp in employees)
                            {
                                <option value="@emp.EmployeeId">@emp.FullName (@emp.EmployeeCode)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold mb-1">Date *</label>
                        <input type="date" class="form-control form-control-sm" @bind="scheduleDate" />
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold mb-1">Shift Type *</label>
                        <select class="form-control form-control-sm" @bind="shiftType">
                            <option value="">-- Select --</option>
                            <option value="Morning">🌅 Morning</option>
                            <option value="Afternoon">☀️ Afternoon</option>
                            <option value="Evening">🌆 Evening</option>
                            <option value="Night">🌙 Night</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold mb-1">Start Time *</label>
                        <input type="time"
                               class="form-control form-control-sm"
                               value="@startTime.ToString(@"hh\:mm")"
                               @onchange="@(e => startTime = TimeSpan.Parse(e.Value?.ToString() ?? "08:00"))" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold mb-1">End Time *</label>
                        <input type="time"
                               class="form-control form-control-sm"
                               value="@endTime.ToString(@"hh\:mm")"
                               @onchange="@(e => endTime = TimeSpan.Parse(e.Value?.ToString() ?? "17:00"))" />
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold mb-1">Location</label>
                        <input type="text" class="form-control form-control-sm" @bind="location" placeholder="Office, Site A, etc." />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold mb-1">Status</label>
                        <select class="form-control form-control-sm" @bind="status">
                            <option value="Scheduled">✅ Scheduled</option>
                            <option value="Completed">✔️ Completed</option>
                            <option value="Absent">❌ Absent</option>
                            <option value="On Leave">🏖️ On Leave</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold mb-1">Notes</label>
                    <textarea class="form-control form-control-sm" rows="2" @bind="notes"></textarea>
                </div>

                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success btn-sm" @onclick="SaveSchedule">💾 Save Schedule</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CancelForm">Cancel</button>
                </div>
            </div>
        </div>
    }
    else if (currentView == "calendar")
    {
        <!-- CALENDAR VIEW -->
        <div class="card shadow-sm">
            <div class="card-header bg-light py-2">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="PreviousMonth">
                            ◀ Prev
                        </button>
                    </div>
                    <div class="col text-center">
                        <h5 class="mb-0">@currentCalendarDate.ToString("MMMM yyyy")</h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-primary" @onclick="GoToToday">
                            📅 Today
                        </button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="NextMonth">
                            Next ▶
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-2">
                <!-- Calendar Legend -->
                <div class="mb-2 p-2 bg-light rounded">
                    <small class="fw-bold">Shift Types: </small>
                    <span class="badge bg-info me-2">🌅 Morning</span>
                    <span class="badge bg-warning me-2">☀️ Afternoon</span>
                    <span class="badge bg-secondary me-2">🌆 Evening</span>
                    <span class="badge bg-dark">🌙 Night</span>
                    <span class="ms-3 text-muted">Click on a date to add schedule</span>
                </div>

                <!-- Calendar Grid -->
                <div class="table-responsive">
                    <table class="table table-bordered calendar-table mb-0">
                        <thead>
                            <tr>
                                <th class="text-center py-2">Sunday</th>
                                <th class="text-center py-2">Monday</th>
                                <th class="text-center py-2">Tuesday</th>
                                <th class="text-center py-2">Wednesday</th>
                                <th class="text-center py-2">Thursday</th>
                                <th class="text-center py-2">Friday</th>
                                <th class="text-center py-2">Saturday</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var week in calendarWeeks)
                            {
                                <tr>
                                    @foreach (var day in week)
                                    {
                                        var daySchedules = GetSchedulesForDate(day);
                                        var isToday = day.Date == DateTime.Today;
                                        var isCurrentMonth = day.Month == currentCalendarDate.Month;

                                        <td class="calendar-day @(isToday ? "today" : "") @(!isCurrentMonth ? "other-month" : "")"
                                            @onclick="@(() => QuickAddSchedule(day))">
                                            <div class="day-number">
                                                @day.Day
                                                @if (daySchedules.Count > 0)
                                                {
                                                    <span class="badge bg-primary rounded-pill">@daySchedules.Count</span>
                                                }
                                            </div>
                                            <div class="day-schedules">
                                                @foreach (var schedule in daySchedules.Take(3))
                                                {
                                                    <div class="schedule-item @GetShiftClass(schedule.ShiftType)"
                                                         @onclick:stopPropagation="true"
                                                         @onclick="@(() => ViewScheduleDetails(schedule))"
                                                         title="@schedule.Employee?.FullName - @schedule.ShiftType">
                                                        <small>
                                                            @GetShiftIcon(schedule.ShiftType)
                                                            @GetEmployeeShortName(schedule.Employee?.FullName)
                                                            <span class="time-text">@FormatTimeSpan(schedule.StartTime)</span>
                                                        </small>
                                                    </div>
                                                }
                                                @if (daySchedules.Count > 3)
                                                {
                                                    <div class="schedule-item more-schedules" @onclick:stopPropagation="true" @onclick="@(() => QuickAddSchedule(day))">
                                                        <small>+ @(daySchedules.Count - 3) more</small>
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else if (currentView == "week")
    {
        <!-- WEEK VIEW WITH TIMELINE -->
        <div class="card shadow-sm">
            <div class="card-header bg-light py-2">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="PreviousWeek">
                            ◀ Prev Week
                        </button>
                    </div>
                    <div class="col text-center">
                        <h5 class="mb-0">
                            @selectedWeekStart.ToString("MMM dd") - @selectedWeekStart.AddDays(6).ToString("MMM dd, yyyy")
                        </h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-primary" @onclick="GoToCurrentWeek">
                            📅 This Week
                        </button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="NextWeek">
                            Next Week ▶
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                    <table class="table table-bordered table-sm week-timeline mb-0">
                        <thead class="sticky-top bg-white" style="z-index: 10;">
                            <tr>
                                <th style="width: 100px; position: sticky; left: 0; z-index: 11; background: white;">Time</th>
                                @for (int i = 0; i < 7; i++)
                                {
                                    var date = selectedWeekStart.AddDays(i);
                                    var isToday = date.Date == DateTime.Today;
                                    <th class="text-center @(isToday ? "bg-warning bg-opacity-25" : "")">
                                        <div class="fw-bold">@date.ToString("ddd")</div>
                                        <div class="small">@date.ToString("MMM dd")</div>
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var timeSlot in timeSlots)
                            {
                                <tr>
                                    <td class="time-column" style="position: sticky; left: 0; background: white; z-index: 5;">
                                        <small class="text-muted">@timeSlot.Label</small>
                                    </td>
                                    @for (int i = 0; i < 7; i++)
                                    {
                                        var date = selectedWeekStart.AddDays(i);
                                        var schedulesInSlot = GetSchedulesForTimeSlot(date, timeSlot.StartTime);
                                        var isToday = date.Date == DateTime.Today;

                                        <td class="schedule-cell @(isToday ? "today-column" : "")"
                                            @onclick="@(() => QuickAddSchedule(date))"
                                            style="cursor: pointer; position: relative; min-height: 60px;">
                                            @if (schedulesInSlot.Any())
                                            {
                                                @foreach (var schedule in schedulesInSlot.Where(s => s.StartTime.Hours == timeSlot.StartTime.Hours))
                                                {
                                                    var rowSpan = GetScheduleRowSpan(schedule);
                                                    <div class="schedule-block @GetShiftClass(schedule.ShiftType)"
                                                         @onclick:stopPropagation="true"
                                                         @onclick="@(() => ViewScheduleDetails(schedule))"
                                                         style="min-height: @(rowSpan * 50)px; cursor: pointer;"
                                                         title="@schedule.Employee?.FullName - @schedule.ShiftType">
                                                        <div class="p-1">
                                                            <small class="fw-bold d-block">@GetShiftIcon(schedule.ShiftType) @GetEmployeeShortName(schedule.Employee?.FullName)</small>
                                                            <small class="text-muted d-block">@FormatTimeSpan(schedule.StartTime) - @FormatTimeSpan(schedule.EndTime)</small>
                                                            @if (!string.IsNullOrEmpty(schedule.Location))
                                                            {
                                                                <small class="text-muted d-block">📍 @schedule.Location</small>
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- LIST VIEW (Original Table) -->
        <div class="card shadow-sm mb-3">
            <div class="card-body p-2">
                <div class="row g-2 align-items-center">
                    <div class="col-auto">
                        <label class="form-label small mb-0 fw-bold">From:</label>
                    </div>
                    <div class="col-auto">
                        <input type="date" class="form-control form-control-sm" @bind="filterStartDate" />
                    </div>
                    <div class="col-auto">
                        <label class="form-label small mb-0 fw-bold">To:</label>
                    </div>
                    <div class="col-auto">
                        <input type="date" class="form-control form-control-sm" @bind="filterEndDate" />
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-sm btn-primary" @onclick="FilterSchedules">Apply Filter</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ResetFilter">Reset</button>
                    </div>
                    <div class="col text-end">
                        <span class="badge bg-info">@displayedSchedules.Count schedules</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="py-2">Date</th>
                                <th class="py-2">Employee</th>
                                <th class="py-2">Position</th>
                                <th class="py-2">Shift</th>
                                <th class="py-2">Time</th>
                                <th class="py-2">Location</th>
                                <th class="py-2 text-center">Status</th>
                                <th class="py-2 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (displayedSchedules.Any())
                            {
                                @foreach (var schedule in displayedSchedules)
                                {
                                    <tr>
                                        <td class="py-2 small">@schedule.Date.ToString("MMM dd, yyyy")</td>
                                        <td class="py-2 small">@schedule.Employee?.FullName</td>
                                        <td class="py-2 small">@schedule.Employee?.Position</td>
                                        <td class="py-2 small">@GetShiftIcon(schedule.ShiftType) @schedule.ShiftType</td>
                                        <td class="py-2 small">@FormatTimeSpan(schedule.StartTime) - @FormatTimeSpan(schedule.EndTime)</td>
                                        <td class="py-2 small">@schedule.Location</td>
                                        <td class="py-2 text-center">
                                            <span class="badge @GetStatusBadgeClass(schedule.Status) small">
                                                @schedule.Status
                                            </span>
                                        </td>
                                        <td class="py-2 text-center">
                                            <button type="button" class="btn btn-sm btn-outline-primary py-0 px-2" @onclick="@(() => EditSchedule(schedule))">✏️</button>
                                            <button type="button" class="btn btn-sm btn-outline-danger py-0 px-2" @onclick="@(() => DeleteSchedule(schedule.ScheduleId))">🗑️</button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-muted">
                                        No schedules found for the selected date range.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Conflict Warning Modal -->
    @if (showConflictWarning && pendingSchedule != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.7);">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning py-2">
                        <h6 class="modal-title mb-0">⚠️ Schedule Conflict Detected</h6>
                        <button type="button" class="btn-close" @onclick="CloseConflictWarning"></button>
                    </div>
                    <div class="modal-body p-3">
                        <div class="alert alert-warning mb-3">
                            <strong>Warning!</strong> This employee already has @conflictingSchedules.Count conflicting schedule(s) at this time.
                        </div>

                        <h6 class="mb-2">New Schedule:</h6>
                        <div class="card bg-light mb-3">
                            <div class="card-body p-2">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Employee:</small>
                                        <div class="fw-bold">@employees.FirstOrDefault(e => e.EmployeeId == pendingSchedule.EmployeeId)?.FullName</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Date & Shift:</small>
                                        <div>@pendingSchedule.Date.ToString("MMM dd, yyyy") - @pendingSchedule.ShiftType</div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Time:</small>
                                        <div>@FormatTimeSpan(pendingSchedule.StartTime) - @FormatTimeSpan(pendingSchedule.EndTime)</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-2">Conflicting Schedule(s):</h6>
                        @foreach (var conflict in conflictingSchedules)
                        {
                            <div class="card border-danger mb-2">
                                <div class="card-body p-2">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Shift:</small>
                                            <div>@GetShiftIcon(conflict.ShiftType) @conflict.ShiftType</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Time:</small>
                                            <div>@FormatTimeSpan(conflict.StartTime) - @FormatTimeSpan(conflict.EndTime)</div>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(conflict.Location))
                                    {
                                        <div class="mt-1">
                                            <small class="text-muted">Location:</small>
                                            <div>📍 @conflict.Location</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-sm btn-secondary" @onclick="CloseConflictWarning">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-sm btn-warning" @onclick="ConfirmScheduleWithConflict">
                            Save Anyway
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Quick Schedule Modal -->
    @if (showQuickScheduleModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.7);">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white py-2">
                        <h6 class="modal-title mb-0">⚡ Quick Schedule - Bulk Assignment</h6>
                        <button type="button" class="btn-close btn-close-white" @onclick="CloseQuickScheduleModal" disabled="@isCreatingBulkSchedules"></button>
                    </div>
                    <div class="modal-body p-3">
                        @if (!isCreatingBulkSchedules)
                        {
                            <div class="row g-3">
                                <!-- Employee Selection -->
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>1️⃣ Select Employees (@selectedEmployeeIds.Count selected)</strong>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-sm btn-light" @onclick="SelectAllEmployees">All</button>
                                                    <button type="button" class="btn btn-sm btn-light" @onclick="DeselectAllEmployees">None</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">
                                            @foreach (var emp in employees.OrderBy(e => e.FullName))
                                            {
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           id="emp-@emp.EmployeeId"
                                                           checked="@selectedEmployeeIds.Contains(emp.EmployeeId)"
                                                           @onchange="@(() => ToggleEmployeeSelection(emp.EmployeeId))" />
                                                    <label class="form-check-label" for="emp-@emp.EmployeeId">
                                                        <strong>@emp.FullName</strong>
                                                        <br />
                                                        <small class="text-muted">@emp.Position - @emp.Department</small>
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- Schedule Configuration -->
                                <div class="col-md-6">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white py-2">
                                            <strong>2️⃣ Schedule Details</strong>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="row g-2 mb-2">
                                                <div class="col-6">
                                                    <label class="form-label small fw-bold mb-1">Start Date *</label>
                                                    <input type="date" class="form-control form-control-sm" @bind="quickScheduleStartDate" />
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label small fw-bold mb-1">End Date *</label>
                                                    <input type="date" class="form-control form-control-sm" @bind="quickScheduleEndDate" />
                                                </div>
                                            </div>

                                            <div class="mb-2">
                                                <label class="form-label small fw-bold mb-1">Shift Type *</label>
                                                <select class="form-select form-select-sm" @bind="quickShiftType">
                                                    <option value="Morning">🌅 Morning</option>
                                                    <option value="Afternoon">☀️ Afternoon</option>
                                                    <option value="Evening">🌆 Evening</option>
                                                    <option value="Night">🌙 Night</option>
                                                </select>
                                            </div>

                                            <div class="row g-2 mb-2">
                                                <div class="col-6">
                                                    <label class="form-label small fw-bold mb-1">Start Time *</label>
                                                    <input type="time"
                                                           class="form-control form-control-sm"
                                                           value="@quickStartTime.ToString(@"hh\:mm")"
                                                           @onchange="@(e => quickStartTime = TimeSpan.Parse(e.Value?.ToString() ?? "08:00"))" />
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label small fw-bold mb-1">End Time *</label>
                                                    <input type="time"
                                                           class="form-control form-control-sm"
                                                           value="@quickEndTime.ToString(@"hh\:mm")"
                                                           @onchange="@(e => quickEndTime = TimeSpan.Parse(e.Value?.ToString() ?? "17:00"))" />
                                                </div>
                                            </div>

                                            <div class="mb-2">
                                                <label class="form-label small fw-bold mb-1">Location</label>
                                                <input type="text" class="form-control form-control-sm" @bind="quickLocation" placeholder="Optional" />
                                            </div>

                                            <div class="mb-2">
                                                <label class="form-label small fw-bold mb-1">Notes</label>
                                                <textarea class="form-control form-control-sm" rows="2" @bind="quickNotes" placeholder="Optional notes..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Day Selection -->
                                <div class="col-12">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>3️⃣ Select Days of Week (@selectedDays.Count selected)</strong>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-sm btn-light" @onclick="SelectWeekdays">Weekdays</button>
                                                    <button type="button" class="btn btn-sm btn-light" @onclick="SelectWeekend">Weekend</button>
                                                    <button type="button" class="btn btn-sm btn-light" @onclick="SelectAllDays">All</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-3">
                                            <div class="d-flex gap-2 flex-wrap justify-content-center">
                                                @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
                                                {
                                                    var isSelected = selectedDays.Contains(day);
                                                    <button type="button"
                                                            class="btn @(isSelected ? "btn-warning" : "btn-outline-warning")"
                                                            @onclick="@(() => ToggleDaySelection(day))"
                                                            style="min-width: 100px;">
                                                        @day.ToString()
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Summary -->
                                <div class="col-12">
                                    <div class="alert alert-info mb-0">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <strong>📊 Summary</strong>
                                            </div>
                                            <div class="col-md-8">
                                                <div class="row">
                                                    <div class="col-4">
                                                        <small class="text-muted">Employees:</small>
                                                        <div class="fw-bold">@selectedEmployeeIds.Count</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted">Days:</small>
                                                        <div class="fw-bold">@selectedDays.Count</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted">Total Schedules:</small>
                                                        <div class="fw-bold text-primary">@CalculateTotalSchedulesToCreate()</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Progress View -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-success mb-3" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Creating schedules...</span>
                                </div>
                                <h5 class="mb-3">Creating Schedules...</h5>
                                <div class="progress mb-3" style="height: 30px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                         role="progressbar"
                                         style="width: @((bulkScheduleProgress * 100.0 / bulkScheduleTotal).ToString("F0"))%"
                                         aria-valuenow="@bulkScheduleProgress"
                                         aria-valuemin="0"
                                         aria-valuemax="@bulkScheduleTotal">
                                        @bulkScheduleProgress / @bulkScheduleTotal
                                    </div>
                                </div>
                                <p class="text-muted">
                                    @((bulkScheduleProgress * 100.0 / bulkScheduleTotal).ToString("F1"))% Complete
                                </p>

                                @if (bulkScheduleErrors.Any())
                                {
                                    <div class="alert alert-warning mt-3 text-start">
                                        <strong>⚠️ Some schedules could not be created:</strong>
                                        <ul class="mb-0 mt-2">
                                            @foreach (var error in bulkScheduleErrors.Take(10))
                                            {
                                                <li><small>@error</small></li>
                                            }
                                            @if (bulkScheduleErrors.Count > 10)
                                            {
                                                <li><small><em>... and @(bulkScheduleErrors.Count - 10) more</em></small></li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    <div class="modal-footer py-2">
                        @if (!isCreatingBulkSchedules)
                        {
                            <button type="button" class="btn btn-sm btn-secondary" @onclick="CloseQuickScheduleModal">
                                Cancel
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-success"
                                    @onclick="CreateBulkSchedules"
                                    disabled="@(!IsQuickScheduleValid())">
                                ⚡ Create @CalculateTotalSchedulesToCreate() Schedules
                            </button>
                        }
                        else if (bulkScheduleProgress >= bulkScheduleTotal)
                        {
                            <button type="button" class="btn btn-sm btn-primary" @onclick="CloseQuickScheduleModal">
                                Done
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Schedule Details Modal -->
@if (showDetailsModal && selectedSchedule != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title mb-0">📅 Schedule Details</h6>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="text-muted small">Employee</label>
                        <h6>@selectedSchedule.Employee?.FullName</h6>
                        <small class="text-muted">@selectedSchedule.Employee?.Position - @selectedSchedule.Employee?.Department</small>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="text-muted small">Date</label>
                            <div>@selectedSchedule.Date.ToString("MMMM dd, yyyy")</div>
                        </div>
                        <div class="col-6">
                            <label class="text-muted small">Shift Type</label>
                            <div>@GetShiftIcon(selectedSchedule.ShiftType) @selectedSchedule.ShiftType</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="text-muted small">Start Time</label>
                            <div>@FormatTimeSpan(selectedSchedule.StartTime)</div>
                        </div>
                        <div class="col-6">
                            <label class="text-muted small">End Time</label>
                            <div>@FormatTimeSpan(selectedSchedule.EndTime)</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Duration</label>
                        <div>@CalculateDuration(selectedSchedule.StartTime, selectedSchedule.EndTime) hours</div>
                    </div>
                    @if (!string.IsNullOrEmpty(selectedSchedule.Location))
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Location</label>
                            <div>📍 @selectedSchedule.Location</div>
                        </div>
                    }
                    <div class="mb-3">
                        <label class="text-muted small">Status</label>
                        <div>
                            <span class="badge @GetStatusBadgeClass(selectedSchedule.Status)">
                                @selectedSchedule.Status
                            </span>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(selectedSchedule.Notes))
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Notes</label>
                            <div class="p-2 bg-light rounded">@selectedSchedule.Notes</div>
                        </div>
                    }
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-primary" @onclick="@(() => EditScheduleFromDetails(selectedSchedule))">✏️ Edit</button>
                    <button type="button" class="btn btn-sm btn-danger" @onclick="@(() => DeleteScheduleFromDetails(selectedSchedule.ScheduleId))">🗑️ Delete</button>
                    <button type="button" class="btn btn-sm btn-secondary" @onclick="CloseDetailsModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<style>

    /* Week Timeline Styles */
    .week-timeline {
        font-size: 0.85rem;
    }

        .week-timeline thead th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

    .time-column {
        background-color: #f8f9fa;
        font-weight: 600;
        vertical-align: middle;
        text-align: center;
    }

    .schedule-cell {
        height: 60px;
        vertical-align: top;
        padding: 2px;
        transition: background-color 0.2s;
    }

        .schedule-cell:hover {
            background-color: #f0f8ff;
        }

        .schedule-cell.today-column {
            background-color: #fffbf0;
        }

    .schedule-block {
        border-radius: 4px;
        padding: 4px;
        margin-bottom: 2px;
        overflow: hidden;
        border-left: 3px solid;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

        .schedule-block.morning {
            background-color: #cfe2ff;
            border-left-color: #0d6efd;
        }

        .schedule-block.afternoon {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }

        .schedule-block.evening {
            background-color: #e2d5f3;
            border-left-color: #6f42c1;
        }

        .schedule-block.night {
            background-color: #d1d3d5;
            border-left-color: #343a40;
        }

        .schedule-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
    /* Calendar Styles */
    .calendar-table {
        table-layout: fixed;
    }

        .calendar-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            font-size: 0.9rem;
        }

    .calendar-day {
        height: 120px;
        vertical-align: top;
        padding: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
        position: relative;
    }

        .calendar-day:hover {
            background-color: #f0f8ff;
        }

        .calendar-day.today {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
        }

        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #999;
        }

    .day-number {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .day-schedules {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .schedule-item {
        padding: 3px 5px;
        border-radius: 3px;
        margin-bottom: 2px;
        cursor: pointer;
        transition: transform 0.2s;
        font-size: 0.75rem;
        line-height: 1.2;
    }

        .schedule-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .schedule-item.morning {
            background-color: #cfe2ff;
            border-left: 3px solid #0d6efd;
        }

        .schedule-item.afternoon {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .schedule-item.evening {
            background-color: #e2d5f3;
            border-left: 3px solid #6f42c1;
        }

        .schedule-item.night {
            background-color: #d1d3d5;
            border-left: 3px solid #343a40;
        }

        .schedule-item.more-schedules {
            background-color: #e9ecef;
            border-left: 3px solid #6c757d;
            text-align: center;
            font-style: italic;
        }

    .time-text {
        opacity: 0.8;
    }
</style>

@code {

    

    // Quick Schedule variables - UPDATED
    private bool showQuickScheduleModal = false;
    private List<int> selectedEmployeeIds = new();
    private DateTime quickScheduleStartDate = DateTime.Today;
    private DateTime quickScheduleEndDate = DateTime.Today.AddDays(6);
    private string quickShiftType = "Morning";
    private TimeSpan quickStartTime = new TimeSpan(8, 0, 0);   // Changed from string
    private TimeSpan quickEndTime = new TimeSpan(17, 0, 0);     // Changed from string
    private string quickLocation = "";
    private string quickNotes = "";
    private List<DayOfWeek> selectedDays = new();
    private bool isCreatingBulkSchedules = false;
    private int bulkScheduleProgress = 0;
    private int bulkScheduleTotal = 0;
    private List<string> bulkScheduleErrors = new();
    // Existing variables
    private List<Schedule> allSchedules = new();
    private List<Schedule> displayedSchedules = new();
    private List<Employee> employees = new();
    private Schedule? editingSchedule = null;
    private bool showAddForm = false;
    private bool isLoading = true;

    private DateTime filterStartDate = DateTime.Today.AddDays(-7);
    private DateTime filterEndDate = DateTime.Today.AddDays(7);

    // Form fields
    
    private int selectedEmployeeId = 0;
    private DateTime scheduleDate = DateTime.Today;
    private string shiftType = "Morning";
    private TimeSpan startTime = new TimeSpan(8, 0, 0);  // Changed from string
    private TimeSpan endTime = new TimeSpan(17, 0, 0);    // Changed from string
    private string location = "";
    private string status = "Scheduled";
    private string notes = "";

    // NEW: Calendar View variables
    private string currentView = "calendar"; // "calendar" or "list"
    private DateTime currentCalendarDate = DateTime.Today;
    private List<List<DateTime>> calendarWeeks = new();

    // NEW: Details Modal
    private bool showDetailsModal = false;
    private Schedule? selectedSchedule = null;

    // Week View variables
    private DateTime selectedWeekStart = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek);
    private List<TimeSlot> timeSlots = new();
    private Dictionary<(DateTime date, TimeSpan time), List<Schedule>> weekScheduleGrid = new();

    private void ShowAddForm()
    {
        
        editingSchedule = null;
        selectedEmployeeId = 0;
        scheduleDate = DateTime.Today;
        shiftType = "Morning";
        startTime = new TimeSpan(8, 0, 0);
        endTime = new TimeSpan(17, 0, 0);
        location = "";
        status = "Scheduled";
        notes = "";
        showAddForm = true;
        StateHasChanged();
    }

    // Quick Schedule Methods
    private void ShowQuickScheduleModal()
    {
        selectedEmployeeIds = new();
        quickScheduleStartDate = DateTime.Today;
        quickScheduleEndDate = DateTime.Today.AddDays(6);
        quickShiftType = "Morning";
        quickStartTime = new TimeSpan(8, 0, 0);   // Updated
        quickEndTime = new TimeSpan(17, 0, 0);     // Updated
        quickLocation = "";
        quickNotes = "";
        selectedDays = new() { DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday };
        bulkScheduleErrors = new();
        showQuickScheduleModal = true;
        StateHasChanged();
    }

    private void CloseQuickScheduleModal()
    {
        showQuickScheduleModal = false;
        selectedEmployeeIds = new();
        isCreatingBulkSchedules = false;
        bulkScheduleProgress = 0;
        bulkScheduleTotal = 0;
        StateHasChanged();
    }

    private void ToggleEmployeeSelection(int employeeId)
    {
        if (selectedEmployeeIds.Contains(employeeId))
        {
            selectedEmployeeIds.Remove(employeeId);
        }
        else
        {
            selectedEmployeeIds.Add(employeeId);
        }
        StateHasChanged();
    }

    private void SelectAllEmployees()
    {
        selectedEmployeeIds = employees.Select(e => e.EmployeeId).ToList();
        StateHasChanged();
    }

    private void DeselectAllEmployees()
    {
        selectedEmployeeIds.Clear();
        StateHasChanged();
    }

    private void ToggleDaySelection(DayOfWeek day)
    {
        if (selectedDays.Contains(day))
        {
            selectedDays.Remove(day);
        }
        else
        {
            selectedDays.Add(day);
        }
        StateHasChanged();
    }

    private void SelectWeekdays()
    {
        selectedDays = new() { DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday };
        StateHasChanged();
    }

    private void SelectWeekend()
    {
        selectedDays = new() { DayOfWeek.Saturday, DayOfWeek.Sunday };
        StateHasChanged();
    }

    private void SelectAllDays()
    {
        selectedDays = new() { DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday, DayOfWeek.Saturday, DayOfWeek.Sunday };
        StateHasChanged();
    }

    private int CalculateTotalSchedulesToCreate()
    {
        var dateRange = (quickScheduleEndDate - quickScheduleStartDate).Days + 1;
        var validDates = 0;

        for (int i = 0; i < dateRange; i++)
        {
            var date = quickScheduleStartDate.AddDays(i);
            if (selectedDays.Contains(date.DayOfWeek))
            {
                validDates++;
            }
        }

        return selectedEmployeeIds.Count * validDates;
    }

    private async Task CreateBulkSchedules()
    {
        if (!selectedEmployeeIds.Any() || !selectedDays.Any())
            return;

        isCreatingBulkSchedules = true;
        bulkScheduleProgress = 0;
        bulkScheduleTotal = CalculateTotalSchedulesToCreate();
        bulkScheduleErrors = new();
        StateHasChanged();

        var dateRange = (quickScheduleEndDate - quickScheduleStartDate).Days + 1;

        var schedulesToCreate = new List<Schedule>();

        // Generate all schedules
        for (int i = 0; i < dateRange; i++)
        {
            var date = quickScheduleStartDate.AddDays(i);

            if (!selectedDays.Contains(date.DayOfWeek))
                continue;

            foreach (var employeeId in selectedEmployeeIds)
            {
                var schedule = new Schedule
                {
                    EmployeeId = employeeId,
                    Date = date,
                    ShiftType = quickShiftType,
                    StartTime = quickStartTime,   // Direct assignment
                    EndTime = quickEndTime,       // Direct assignment
                    Location = quickLocation,
                    Status = "Scheduled",
                    Notes = quickNotes,
                    IsActive = true
                };

                schedulesToCreate.Add(schedule);
            }
        }

        // Create schedules with conflict checking
        foreach (var schedule in schedulesToCreate)
        {
            try
            {
                var conflicts = await CheckScheduleConflicts(schedule);

                if (conflicts.Any())
                {
                    var employee = employees.FirstOrDefault(e => e.EmployeeId == schedule.EmployeeId);
                    bulkScheduleErrors.Add($"{employee?.FullName} on {schedule.Date:MMM dd} - Conflict detected");
                }
                else
                {
                    var success = await ManpowerService.AddScheduleAsync(schedule);
                    if (!success)
                    {
                        var employee = employees.FirstOrDefault(e => e.EmployeeId == schedule.EmployeeId);
                        bulkScheduleErrors.Add($"{employee?.FullName} on {schedule.Date:MMM dd} - Failed to save");
                    }
                }

                bulkScheduleProgress++;
                StateHasChanged();

                // Small delay to show progress
                await Task.Delay(50);
            }
            catch (Exception ex)
            {
                var employee = employees.FirstOrDefault(e => e.EmployeeId == schedule.EmployeeId);
                bulkScheduleErrors.Add($"{employee?.FullName} on {schedule.Date:MMM dd} - Error: {ex.Message}");
                bulkScheduleProgress++;
            }
        }

        // Reload data
        await LoadData();

        // Show completion message
        if (bulkScheduleErrors.Any())
        {
            await ShowToast("warning", "Bulk Schedule Completed with Errors",
                $"Created {bulkScheduleProgress - bulkScheduleErrors.Count} schedules. {bulkScheduleErrors.Count} failed.");
        }
        else
        {
            await ShowToast("success", "Bulk Schedule Created!",
                $"Successfully created {bulkScheduleProgress} schedules.");
            CloseQuickScheduleModal();
        }

        isCreatingBulkSchedules = false;
        StateHasChanged();
    }

    private bool IsQuickScheduleValid()
    {
        return selectedEmployeeIds.Any() &&
               selectedDays.Any() &&
               !string.IsNullOrWhiteSpace(quickShiftType) &&
               quickScheduleEndDate >= quickScheduleStartDate;
    }


    // Helper class for time slots
    public class TimeSlot
    {
        public TimeSpan StartTime { get; set; }
        public TimeSpan EndTime { get; set; }
        public string Label { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        InitializeTimeSlots();
        await LoadData();
        GenerateCalendarWeeks();
    }
   

    private void InitializeTimeSlots()
    {
        timeSlots.Clear();
        for (int hour = 0; hour < 24; hour++)
        {
            timeSlots.Add(new TimeSlot
            {
                StartTime = new TimeSpan(hour, 0, 0),
                EndTime = new TimeSpan(hour + 1, 0, 0),
                Label = DateTime.Today.Add(new TimeSpan(hour, 0, 0)).ToString("hh:mm tt")
            });
        }
    }

    private async Task ShowToast(string type, string title, string message)
    {
        try
        {
            var toastType = type switch
            {
                "success" => "success",
                "error" => "danger",
                "info" => "info",
                "warning" => "warning",
                _ => "info"
            };

            await JSRuntime.InvokeVoidAsync("showToast", toastType, title, message);
        }
        catch
        {
            // Toast failed silently
        }
    }
    // Conflict Detection
    private async Task<List<Schedule>> CheckScheduleConflicts(Schedule newSchedule)
    {
        var conflicts = new List<Schedule>();

        // Get all schedules for the same employee on the same date
        var employeeSchedules = await ManpowerService.GetSchedulesByDateAsync(newSchedule.Date);
        var relevantSchedules = employeeSchedules
            .Where(s => s.EmployeeId == newSchedule.EmployeeId &&
                        s.IsActive &&
                        (newSchedule.ScheduleId == 0 || s.ScheduleId != newSchedule.ScheduleId))
            .ToList();

        foreach (var existingSchedule in relevantSchedules)
        {
            // Check if time ranges overlap
            if (TimesOverlap(newSchedule.StartTime, newSchedule.EndTime,
                            existingSchedule.StartTime, existingSchedule.EndTime))
            {
                conflicts.Add(existingSchedule);
            }
        }

        return conflicts;
    }

    private bool TimesOverlap(TimeSpan start1, TimeSpan end1, TimeSpan start2, TimeSpan end2)
    {
        // Handle overnight shifts
        if (end1 < start1) end1 = end1.Add(TimeSpan.FromDays(1));
        if (end2 < start2) end2 = end2.Add(TimeSpan.FromDays(1));

        return start1 < end2 && end1 > start2;
    }

    private bool showConflictWarning = false;
    private List<Schedule> conflictingSchedules = new();
    private Schedule? pendingSchedule = null;

    private void BuildWeekScheduleGrid()
    {
        weekScheduleGrid.Clear();

        var weekEnd = selectedWeekStart.AddDays(7);
        var weekSchedules = allSchedules
            .Where(s => s.Date >= selectedWeekStart && s.Date < weekEnd && s.IsActive)
            .ToList();

        foreach (var schedule in weekSchedules)
        {
            var startHour = schedule.StartTime.Hours;
            var endHour = schedule.EndTime.Hours;

            for (int hour = startHour; hour <= endHour; hour++)
            {
                var timeSlot = new TimeSpan(hour, 0, 0);
                var key = (schedule.Date.Date, timeSlot);

                if (!weekScheduleGrid.ContainsKey(key))
                {
                    weekScheduleGrid[key] = new List<Schedule>();
                }

                if (hour == startHour || !weekScheduleGrid[key].Contains(schedule))
                {
                    weekScheduleGrid[key].Add(schedule);
                }
            }
        }
    }

    private void PreviousWeek()
    {
        selectedWeekStart = selectedWeekStart.AddDays(-7);
        BuildWeekScheduleGrid();
        StateHasChanged();
    }

    private void NextWeek()
    {
        selectedWeekStart = selectedWeekStart.AddDays(7);
        BuildWeekScheduleGrid();
        StateHasChanged();
    }

    private void GoToCurrentWeek()
    {
        selectedWeekStart = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek);
        BuildWeekScheduleGrid();
        StateHasChanged();
    }

    private List<Schedule> GetSchedulesForTimeSlot(DateTime date, TimeSpan time)
    {
        var key = (date.Date, time);
        return weekScheduleGrid.ContainsKey(key) ? weekScheduleGrid[key] : new List<Schedule>();
    }

    private int GetScheduleRowSpan(Schedule schedule)
    {
        var duration = schedule.EndTime - schedule.StartTime;
        return Math.Max(1, (int)Math.Ceiling(duration.TotalHours));
    }

    private async Task LoadData()
    {
        isLoading = true;
        employees = await ManpowerService.GetAllEmployeesAsync();

        var startOfMonth = new DateTime(currentCalendarDate.Year, currentCalendarDate.Month, 1);
        var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);
        allSchedules = await ManpowerService.GetSchedulesByDateRangeAsync(startOfMonth.AddDays(-7), endOfMonth.AddDays(7));
        displayedSchedules = allSchedules;

        BuildWeekScheduleGrid(); // Add this line
        isLoading = false;
    }

    // NEW: Calendar Methods
    private void GenerateCalendarWeeks()
    {
        calendarWeeks.Clear();

        var firstDayOfMonth = new DateTime(currentCalendarDate.Year, currentCalendarDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        // Start from the Sunday before the first day of the month
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);

        // Continue until we have all days including the Saturday after the last day
        var endDate = lastDayOfMonth;
        while (endDate.DayOfWeek != DayOfWeek.Saturday)
        {
            endDate = endDate.AddDays(1);
        }

        var currentDate = startDate;
        while (currentDate <= endDate)
        {
            var week = new List<DateTime>();
            for (int i = 0; i < 7; i++)
            {
                week.Add(currentDate);
                currentDate = currentDate.AddDays(1);
            }
            calendarWeeks.Add(week);
        }
    }

    private List<Schedule> GetSchedulesForDate(DateTime date)
    {
        return allSchedules.Where(s => s.Date.Date == date.Date && s.IsActive).ToList();
    }

    private async Task ChangeView(string view)
    {
        currentView = view;
        if (view == "week")
        {
            BuildWeekScheduleGrid();
        }
        await Task.CompletedTask; // Satisfy async requirement
        StateHasChanged();
    }

    private async Task PreviousMonth()
    {
        currentCalendarDate = currentCalendarDate.AddMonths(-1);
        GenerateCalendarWeeks();
        await LoadData();
    }

    private async Task NextMonth()
    {
        currentCalendarDate = currentCalendarDate.AddMonths(1);
        GenerateCalendarWeeks();
        await LoadData();
    }

    private async Task GoToToday()
    {
        currentCalendarDate = DateTime.Today;
        GenerateCalendarWeeks();
        await LoadData();
    }

    private void QuickAddSchedule(DateTime date)
    {
        scheduleDate = date;
        ShowAddForm();
    }

    private void ViewScheduleDetails(Schedule schedule)
    {
        selectedSchedule = schedule;
        showDetailsModal = true;
        StateHasChanged();
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedSchedule = null;
        StateHasChanged();
    }

    private void EditScheduleFromDetails(Schedule schedule)
    {
        CloseDetailsModal();
        EditSchedule(schedule);
    }

    private async Task DeleteScheduleFromDetails(int scheduleId)
    {
        CloseDetailsModal();
        await DeleteSchedule(scheduleId);
    }

    private string GetShiftClass(string shiftType)
    {
        return shiftType.ToLower() switch
        {
            "morning" => "morning",
            "afternoon" => "afternoon",
            "evening" => "evening",
            "night" => "night",
            _ => ""
        };
    }

    private string GetShiftIcon(string shiftType)
    {
        return shiftType switch
        {
            "Morning" => "🌅",
            "Afternoon" => "☀️",
            "Evening" => "🌆",
            "Night" => "🌙",
            _ => "📅"
        };
    }

    private string GetEmployeeShortName(string? fullName)
    {
        if (string.IsNullOrEmpty(fullName)) return "Unknown";

        var parts = fullName.Split(' ');
        if (parts.Length >= 2)
        {
            return $"{parts[0]} {parts[parts.Length - 1][0]}.";
        }
        return fullName.Length > 15 ? fullName.Substring(0, 15) + "..." : fullName;
    }

    private decimal CalculateDuration(TimeSpan start, TimeSpan end)
    {
        var duration = end - start;
        if (duration.TotalHours < 0)
        {
            duration = duration.Add(TimeSpan.FromHours(24));
        }
        return (decimal)Math.Round(duration.TotalHours, 1);
    }

    // Existing methods
    private async Task FilterSchedules()
    {
        allSchedules = await ManpowerService.GetSchedulesByDateRangeAsync(filterStartDate, filterEndDate);
        displayedSchedules = allSchedules;
        StateHasChanged();
    }

    private async Task ResetFilter()
    {
        filterStartDate = DateTime.Today.AddDays(-7);
        filterEndDate = DateTime.Today.AddDays(7);
        await FilterSchedules();
    }

    

    private void EditSchedule(Schedule schedule)
    {
        editingSchedule = schedule;
        selectedEmployeeId = schedule.EmployeeId;
        scheduleDate = schedule.Date;
        shiftType = schedule.ShiftType;
        startTime = schedule.StartTime;  // Direct assignment
        endTime = schedule.EndTime;      // Direct assignment
        location = schedule.Location ?? "";
        status = schedule.Status;
        notes = schedule.Notes ?? "";
        showAddForm = true;
        StateHasChanged();
    }

    private async Task SaveSchedule()
    {
        if (selectedEmployeeId == 0 || string.IsNullOrEmpty(shiftType))
            return;

        var schedule = editingSchedule ?? new Schedule();
        schedule.EmployeeId = selectedEmployeeId;
        schedule.Date = scheduleDate;
        schedule.ShiftType = shiftType;
        schedule.StartTime = startTime;   // Direct assignment
        schedule.EndTime = endTime;       // Direct assignment
        schedule.Location = location;
        schedule.Status = status;
        schedule.Notes = notes;
        schedule.IsActive = true;

        // Check for conflicts
        var conflicts = await CheckScheduleConflicts(schedule);

        if (conflicts.Any())
        {
            pendingSchedule = schedule;
            conflictingSchedules = conflicts;
            showConflictWarning = true;
            StateHasChanged();
            return;
        }

        await PerformSaveSchedule(schedule);
    }

    private async Task PerformSaveSchedule(Schedule schedule)
    {
        bool success;
        if (editingSchedule != null)
        {
            success = await ManpowerService.UpdateScheduleAsync(schedule);
        }
        else
        {
            success = await ManpowerService.AddScheduleAsync(schedule);
        }

        if (success)
        {
            await LoadData();
            CancelForm();
        }
    }

    private async Task ConfirmScheduleWithConflict()
    {
        if (pendingSchedule != null)
        {
            await PerformSaveSchedule(pendingSchedule);
            CloseConflictWarning();
        }
    }

    private void CloseConflictWarning()
    {
        showConflictWarning = false;
        conflictingSchedules = new();
        pendingSchedule = null;
        StateHasChanged();
    }

    private void CancelForm()
    {
        showAddForm = false;
        editingSchedule = null;
        StateHasChanged();
    }

    private async Task DeleteSchedule(int id)
    {
        await ManpowerService.DeleteScheduleAsync(id);
        await LoadData();
    }

    private string FormatTimeSpan(TimeSpan time)
    {
        return DateTime.Today.Add(time).ToString("hh:mm tt");
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Scheduled" => "bg-primary",
            "Completed" => "bg-success",
            "Absent" => "bg-danger",
            "On Leave" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }
}
