@page "/employees"
@using DVTech_ODSS.Models
@using DVTech_ODSS.Services
@inject ManpowerService ManpowerService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Employee Management</PageTitle>

<div class="container-fluid">
    <div class="row mb-3 align-items-center">
        <div class="col">
            <h3 class="mb-0">👥 Employee Management</h3>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowAddForm">
                ➕ Add New Employee
            </button>
        </div>
    </div>

    <!-- Summary Statistics Dashboard -->
    @if (!showAddForm && !isLoading)
    {
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <div class="card shadow-sm border-primary">
                    <div class="card-body p-3">
                        <p class="text-muted small mb-1">👥 Total Employees</p>
                        <h4 class="mb-0 text-primary">@employees.Count</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-success">
                    <div class="card-body p-3">
                        <p class="text-muted small mb-1">✅ Active</p>
                        <h4 class="mb-0 text-success">@employees.Count(e => e.Status == "Active")</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-warning">
                    <div class="card-body p-3">
                        <p class="text-muted small mb-1">🏖️ On Leave</p>
                        <h4 class="mb-0 text-warning">@employees.Count(e => e.Status == "On Leave")</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-info">
                    <div class="card-body p-3">
                        <p class="text-muted small mb-1">📅 Recent Hires (30d)</p>
                        <h4 class="mb-0 text-info">@employees.Count(e => e.DateHired >= DateTime.Now.AddDays(-30))</h4>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (showAddForm)
    {
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0">@(editingEmployee != null ? "Edit Employee" : "Add New Employee")</h6>
            </div>
            <div class="card-body p-3">
                <EditForm Model="currentEmployee" OnValidSubmit="SaveEmployee">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="row g-2 mb-2">
                        <div class="col-md-3">
                            <label class="form-label small fw-bold mb-1">Last Name *</label>
                            <InputText class="@GetLastNameClass()"
                                       @bind-Value="currentEmployee.LastName"
                                       @oninput="@((e) => { currentEmployee.LastName = e.Value?.ToString() ?? string.Empty; UpdateEmployeeFullName(); StateHasChanged(); })"
                                       placeholder="Enter last name"
                                       maxlength="50" />
                            @if (string.IsNullOrWhiteSpace(currentEmployee.LastName))
                            {
                                <small class="text-muted">Last name is required</small>
                            }
                            else if (!IsValidName(currentEmployee.LastName))
                            {
                                <small class="text-muted">Last name must contain only letters and spaces</small>
                            }
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold mb-1">First Name *</label>
                            <InputText class="@GetFirstNameClass()"
                                       @bind-Value="currentEmployee.FirstName"
                                       @oninput="@((e) => { currentEmployee.FirstName = e.Value?.ToString() ?? string.Empty; UpdateEmployeeFullName(); StateHasChanged(); })"
                                       placeholder="Enter first name"
                                       maxlength="50" />
                            @if (string.IsNullOrWhiteSpace(currentEmployee.LastName))
                            {
                                <small class="text-muted">First name is required</small>
                            }
                            else if (!IsValidName(currentEmployee.LastName))
                            {
                                <small class="text-muted">First name must contain only letters and spaces</small>
                            }
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold mb-1">Middle Name</label>
                            <InputText class="@GetMiddleNameClass()"
                                       @bind-Value="currentEmployee.MiddleName"
                                       @oninput="@((e) => { currentEmployee.MiddleName = e.Value?.ToString(); UpdateEmployeeFullName(); StateHasChanged(); })"
                                       placeholder="Optional"
                                       maxlength="50" />
                            @if (!IsValidName(currentEmployee.MiddleName) && !string.IsNullOrWhiteSpace(currentEmployee.MiddleName))
                            {
                                <div class="invalid-feedback d-block">Middle name must contain only letters and spaces</div>
                            }
                            <small class="text-muted">Optional</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold mb-1">Suffix</label>
                            <InputSelect class="form-control"
                                         @bind-Value="currentEmployee.Suffix"
                                         @oninput="@((e) => { currentEmployee.Suffix = e.Value?.ToString(); UpdateEmployeeFullName(); StateHasChanged(); })">
                                <option value="">-- None --</option>
                                <option value="Jr.">Jr.</option>
                                <option value="Sr.">Sr.</option>
                                <option value="II">II</option>
                                <option value="III">III</option>
                                <option value="IV">IV</option>
                                <option value="V">V</option>
                            </InputSelect>
                            <small class="text-muted">Optional</small>
                        </div>
                    </div>

                    <!-- Display Full Name Preview -->
                    @if (!string.IsNullOrWhiteSpace(currentEmployee.FirstName) || !string.IsNullOrWhiteSpace(currentEmployee.LastName))
                    {
                        <div class="row g-2 mb-3">
                            <div class="col-12">
                                <div class="alert alert-info py-2 mb-0">
                                    <small class="text-muted">Full Name Preview:</small>
                                    <strong class="d-block">@currentEmployee.FullName</strong>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="col-md-6">
                        <label class="form-label small fw-bold mb-1">Employee Code *</label>
                        <InputText class="@GetEmployeeCodeClass()"
                                   @bind-Value="currentEmployee.EmployeeCode"
                                   placeholder="EMP-2025-001"
                                   maxlength="50"
                                   readonly="@(editingEmployee == null)" />
                        @if (string.IsNullOrWhiteSpace(currentEmployee.EmployeeCode))
                        {
                            <div class="invalid-feedback d-block">Employee code is required</div>
                        }
                        else if (!IsValidEmployeeCode(currentEmployee.EmployeeCode))
                        {
                            <div class="invalid-feedback d-block">Employee code must contain letters, numbers, and hyphens only</div>
                        }
                        else if (editingEmployee == null)
                        {
                            <small class="text-muted">Auto-generated code.</small>
                        }
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold mb-1">Email</label>
                            <InputText class="@GetEmailClass()"
                                       type="email"
                                       @bind-Value="currentEmployee.Email"
                                       placeholder="employee@example.com"
                                       maxlength="100" />
                            @if (!IsValidEmail(currentEmployee.Email) && !string.IsNullOrWhiteSpace(currentEmployee.Email))
                            {
                                <div class="invalid-feedback d-block">Please enter a valid email address</div>
                            }
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold mb-1">Phone Number</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">+63</span>
                                <input type="text"
                                       class="@GetPhoneNumberClass()"
                                       @bind="phoneNumberInput"
                                       @oninput="@HandlePhoneInput"
                                       placeholder="9XX XXX XXXX"
                                       maxlength="13" />
                            </div>
                            @if (!IsValidPhoneNumber(currentEmployee.PhoneNumber) && !string.IsNullOrWhiteSpace(currentEmployee.PhoneNumber))
                            {
                                <div class="invalid-feedback d-block">
                                    @if (string.IsNullOrWhiteSpace(phoneNumberInput) || !phoneNumberInput.StartsWith("9"))
                                    {
                                        <span>Philippine mobile numbers must start with 9</span>
                                    }
                                    else
                                    {
                                        <span>Phone number must be 10 digits (9XX XXX XXXX)</span>
                                    }
                                </div>
                            }
                            <small class="text-muted">Format: 9XX XXX XXXX (10 digits)</small>
                        </div>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold mb-1">Position *</label>
                            <input list="positionList"
                                   type="text"
                                   class="@GetPositionClass()"
                                   @bind="currentEmployee.Position"
                                   @oninput="@((e) => { currentEmployee.Position = e.Value?.ToString() ?? string.Empty; StateHasChanged(); })"
                                   placeholder="Enter position"
                                   maxlength="50" />
                            <datalist id="positionList">
                                <option value="Technician" />
                                <option value="Senior Technician" />
                                <option value="Engineer" />
                                <option value="Manager" />
                                <option value="Supervisor" />
                                <option value="Administrative Staff" />
                                <option value="Sales Representative" />
                                <option value="Accountant" />
                            </datalist>


                            @if (string.IsNullOrWhiteSpace(currentEmployee.Position))
                            {
                                <div class="invalid-feedback text-muted">Position is required</div>
                            }
                            else if (!IsValidPosition(currentEmployee.Position))
                            {
                                <div class="invalid-feedback text-muted">Position must contain letters and may include numbers or spaces</div>
                            }
                           
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold mb-1">Department *</label>
                            <input list="departmentList"
                                   type="text"
                                   class="@GetDepartmentClass()"
                                   @bind="currentEmployee.Department"
                                   @oninput="@((e) => { currentEmployee.Department = e.Value?.ToString() ?? string.Empty; StateHasChanged(); })"
                                   placeholder="Enter department"
                                   maxlength="50" />
                            <datalist id="departmentList">
                                <option value="Technical Services" />
                                <option value="Engineering" />
                                <option value="Sales" />
                                <option value="Administration" />
                                <option value="Finance" />
                                <option value="Operations" />
                                <option value="Human Resources" />
                            </datalist>
                            @if (string.IsNullOrWhiteSpace(currentEmployee.Department))
                            {
                                <div class="invalid-feedback text-muted">Department is required</div>
                            }
                            else if (!IsValidDepartment(currentEmployee.Department))
                            {
                                <div class="invalid-feedback text-muted">Department must contain letters and may include spaces</div>
                            }
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold mb-1">Status</label>
                            <InputSelect class="form-control form-control-sm" @bind-Value="currentEmployee.Status">
                                <option value="Active">Active</option>
                                <option value="On Leave">On Leave</option>
                                <option value="Inactive">Inactive</option>
                            </InputSelect>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success btn-sm" disabled="@(!IsFormValid())">💾 Save Employee</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CancelForm">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
    else
    {
        <!-- Search and Filter Section -->
        <div class="card shadow-sm mb-3">
            <div class="card-body p-2">
                <div class="row g-2 align-items-center mb-2">
                    <div class="col-md-4">
                        <input type="text" class="form-control form-control-sm" placeholder="🔍 Search by name, code, or position..." @bind="searchText" @bind:event="oninput" @onkeyup="ApplyFilters" />
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" @onchange="OnDepartmentFilterChanged">
                            <option value="">All Departments</option>
                            @foreach (var dept in GetAllDepartments())
                            {
                                <option value="@dept">@dept</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" @onchange="OnStatusFilterChanged">
                            <option value="">All Status</option>
                            <option value="Active">Active</option>
                            <option value="On Leave">On Leave</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3 text-end">
                        @if (!string.IsNullOrEmpty(searchText) || !string.IsNullOrEmpty(selectedDepartment) || !string.IsNullOrEmpty(selectedStatus))
                        {
                            <span class="badge bg-info me-2">@filteredEmployees.Count employees shown</span>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="ClearFilters">Clear</button>
                        }
                    </div>
                </div>
                <div class="row g-2 align-items-center">
                    <div class="col-md-6">
                    </div>
                    <div class="col-md-6 text-end">
                        @if (totalPages > 1)
                        {
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                                    ◀ Previous
                                </button>
                                <button type="button" class="btn btn-outline-secondary disabled">
                                    Page @currentPage of @totalPages
                                </button>
                                <button type="button" class="btn btn-outline-secondary" @onclick="NextPage" disabled="@(currentPage == totalPages)">
                                    Next ▶
                                </button>
                            </div>
                            <select class="form-select form-select-sm d-inline-block w-auto ms-2" @onchange="OnPageSizeChanged" style="vertical-align: middle;">
                                <option value="10" selected="@(pageSize == 10)">10 per page</option>
                                <option value="25" selected="@(pageSize == 25)">25 per page</option>
                                <option value="50" selected="@(pageSize == 50)">50 per page</option>
                                <option value="100" selected="@(pageSize == 100)">100 per page</option>
                            </select>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="py-2" style="cursor: pointer;" @onclick='() => SortBy("Code")'>
                                    Code @GetSortIcon("Code")
                                </th>
                                <th class="py-2" style="cursor: pointer;" @onclick='() => SortBy("Name")'>
                                    Full Name @GetSortIcon("Name")
                                </th>
                                <th class="py-2" style="cursor: pointer;" @onclick='() => SortBy("Position")'>
                                    Position @GetSortIcon("Position")
                                </th>
                                <th class="py-2" style="cursor: pointer;" @onclick='() => SortBy("Department")'>
                                    Department @GetSortIcon("Department")
                                </th>
                                <th class="py-2">Phone</th>
                                <th class="py-2">Email</th>
                                <th class="py-2 text-center">Status</th>
                                <th class="py-2 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (paginatedEmployees.Any())
                            {
                                @foreach (var employee in paginatedEmployees)
                                {
                                    <tr style="cursor: pointer;" @onclick="() => ViewEmployeeDetails(employee)">
                                        <td class="py-2 small"><strong>@employee.EmployeeCode</strong></td>
                                        <td class="py-2 small">@employee.FullName</td>
                                        <td class="py-2 small">@employee.Position</td>
                                        <td class="py-2 small">@employee.Department</td>
                                        <td class="py-2 small">@employee.PhoneNumber</td>
                                        <td class="py-2 small">@employee.Email</td>
                                        <td class="py-2 text-center">
                                            <span class="badge @GetStatusBadgeClass(employee.Status) small">
                                                @employee.Status
                                            </span>
                                        </td>
                                        <td class="py-2 text-center" @onclick:stopPropagation="true">
                                            <button class="btn btn-sm btn-outline-primary py-0 px-2 me-1" @onclick="() => EditEmployee(employee)" title="Edit Employee">✏️</button>
                                            <button class="btn btn-sm btn-outline-danger py-0 px-2" @onclick="() => ShowDeleteConfirmation(employee)" title="Delete Employee">🗑️</button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-muted">
                                        @if (!string.IsNullOrEmpty(searchText) || !string.IsNullOrEmpty(selectedDepartment) || !string.IsNullOrEmpty(selectedStatus))
                                        {
                                            <p class="mb-0">No employees match your filters.</p>
                                        }
                                        else
                                        {
                                            <p class="mb-0">No employees found.</p>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<!-- Employee Details Modal -->
@if (showDetailsModal && selectedEmployee != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title mb-0">👤 Employee Details</h6>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 64px; height: 64px; font-size: 24px;">
                                    @GetInitials(selectedEmployee.FullName)
                                </div>
                                <div>
                                    <h5 class="mb-1">@selectedEmployee.FullName</h5>
                                    <p class="text-muted small mb-0">@selectedEmployee.Position</p>
                                    <p class="text-muted small mb-0"><strong>@selectedEmployee.EmployeeCode</strong></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge @GetStatusBadgeClass(selectedEmployee.Status) px-3 py-2 mb-2">
                                @selectedEmployee.Status
                            </span>
                            <div class="small text-muted">
                                <strong>Tenure:</strong> @CalculateTenure(selectedEmployee.DateHired)
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <!-- Contact Information -->
                        <div class="col-md-6">
                            <div class="card bg-light border-0">
                                <div class="card-body p-3">
                                    <h6 class="text-primary mb-3">📞 Contact Information</h6>
                                    <div class="mb-2">
                                        <label class="small text-muted mb-0">Phone</label>
                                        <p class="mb-0">
                                            @if (!string.IsNullOrEmpty(selectedEmployee.PhoneNumber))
                                            {
                                                <a href="tel:@selectedEmployee.PhoneNumber">@selectedEmployee.PhoneNumber</a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not provided</span>
                                            }
                                        </p>
                                    </div>
                                    <div>
                                        <label class="small text-muted mb-0">Email</label>
                                        <p class="mb-0">
                                            @if (!string.IsNullOrEmpty(selectedEmployee.Email))
                                            {
                                                <a href="mailto:@selectedEmployee.Email">@selectedEmployee.Email</a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not provided</span>
                                            }
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Employment Information -->
                        <div class="col-md-6">
                            <div class="card bg-light border-0">
                                <div class="card-body p-3">
                                    <h6 class="text-primary mb-3">💼 Employment Information</h6>
                                    <div class="mb-2">
                                        <label class="small text-muted mb-0">Department</label>
                                        <p class="mb-0"><strong>@selectedEmployee.Department</strong></p>
                                    </div>
                                    <div>
                                        <label class="small text-muted mb-0">Date Hired</label>
                                        <p class="mb-0">@selectedEmployee.DateHired.ToString("MMMM dd, yyyy")</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Statistics -->
                        <div class="col-md-12">
                            <div class="card bg-light border-0">
                                <div class="card-body p-3">
                                    <h6 class="text-primary mb-3">📅 Schedule Statistics</h6>
                                    @if (isLoadingSchedules)
                                    {
                                        <div class="text-center py-2">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2 small text-muted">Loading schedule data...</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <div class="text-center p-2 bg-white rounded">
                                                    <h4 class="mb-0 text-primary">@employeeSchedules.Count</h4>
                                                    <small class="text-muted">Total Schedules</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center p-2 bg-white rounded">
                                                    <h4 class="mb-0 text-success">@employeeSchedules.Count(s => s.Status == "Completed")</h4>
                                                    <small class="text-muted">Completed</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center p-2 bg-white rounded">
                                                    <h4 class="mb-0 text-info">@employeeSchedules.Count(s => s.Status == "Scheduled" && s.Date >= DateTime.Today)</h4>
                                                    <small class="text-muted">Upcoming</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center p-2 bg-white rounded">
                                                    <h4 class="mb-0 text-warning">@employeeSchedules.Count(s => s.Status == "Absent")</h4>
                                                    <small class="text-muted">Absent</small>
                                                </div>
                                            </div>
                                        </div>

                                        @if (employeeSchedules.Any(s => s.Status == "Scheduled" && s.Date >= DateTime.Today))
                                        {
                                            <div class="mt-3">
                                                <h6 class="small text-muted mb-2">Upcoming Schedules:</h6>
                                                <div class="list-group">
                                                    @foreach (var schedule in employeeSchedules.Where(s => s.Status == "Scheduled" && s.Date >= DateTime.Today).OrderBy(s => s.Date).Take(3))
                                                    {
                                                        <div class="list-group-item list-group-item-action py-2">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <strong>@schedule.Date.ToString("MMM dd, yyyy")</strong> - @schedule.ShiftType
                                                                    <br />
                                                                    <small class="text-muted">@schedule.StartTime.ToString(@"hh\:mm") - @schedule.EndTime.ToString(@"hh\:mm")</small>
                                                                    @if (!string.IsNullOrEmpty(schedule.Location))
                                                                    {
                                                                        <br />
                                                                        <small class="text-muted">📍 @schedule.Location</small>
                                                                    }
                                                                </div>
                                                                <span class="badge bg-info">@schedule.Status</span>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-primary" @onclick="() => EditEmployee(selectedEmployee)">✏️ Edit Employee</button>
                    <button type="button" class="btn btn-sm btn-secondary" @onclick="CloseDetailsModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation && employeeToDelete != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.7);">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header py-2 bg-danger text-white">
                    <h6 class="modal-title mb-0">⚠️ Confirm Delete</h6>
                </div>
                <div class="modal-body p-3">
                    <p class="mb-2">Are you sure you want to delete this employee?</p>
                    <div class="alert alert-warning py-2 mb-2">
                        <strong>@employeeToDelete.FullName</strong><br />
                        <small>@employeeToDelete.EmployeeCode - @employeeToDelete.Position</small>
                    </div>
                    <p class="small text-muted mb-0">This action cannot be undone.</p>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-secondary" @onclick="CancelDelete">Cancel</button>
                    <button type="button" class="btn btn-sm btn-danger" @onclick="ConfirmDelete">Yes, Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Employee> employees = new();
    private List<Employee> filteredEmployees = new();
    private Employee currentEmployee = new();
    private Employee? editingEmployee = null;
    private Employee? selectedEmployee = null;
    private Employee? employeeToDelete = null;
    private bool showAddForm = false;
    private bool showDetailsModal = false;
    private bool showDeleteConfirmation = false;
    private bool isLoading = true;

    // Filter variables
    private string searchText = string.Empty;
    private string selectedDepartment = string.Empty;
    private string selectedStatus = string.Empty;

    // Phone number formatting
    private string phoneNumberInput = string.Empty;

    // Schedule data for details modal
    private List<Schedule> employeeSchedules = new();
    private bool isLoadingSchedules = false;

    // Sorting variables
    private string currentSortColumn = "";
    private bool isSortAscending = true;

    // Pagination variables
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private List<Employee> paginatedEmployees = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        isLoading = true;
        employees = await ManpowerService.GetAllEmployeesAsync();
        filteredEmployees = employees;
        isLoading = false;
        ApplyFilters();
    }

    private void ShowAddForm()
    {
        currentEmployee = new Employee();
        editingEmployee = null;
        phoneNumberInput = ""; // Clear phone input
        GenerateEmployeeCode();
        showAddForm = true;
    }

    private void EditEmployee(Employee employee)
    {
        editingEmployee = employee;
        currentEmployee = new Employee
        {
            EmployeeId = employee.EmployeeId,
            LastName = employee.LastName,
            FirstName = employee.FirstName,
            MiddleName = employee.MiddleName,
            Suffix = employee.Suffix,
            FullName = employee.FullName,
            EmployeeCode = employee.EmployeeCode,
            Email = employee.Email,
            PhoneNumber = employee.PhoneNumber,
            Position = employee.Position,
            Department = employee.Department,
            Status = employee.Status,
            DateHired = employee.DateHired,
            IsActive = employee.IsActive
        };

        // Extract phone number input for display (remove +63 prefix)
        if (!string.IsNullOrWhiteSpace(employee.PhoneNumber) && employee.PhoneNumber.StartsWith("+63 "))
        {
            phoneNumberInput = employee.PhoneNumber.Substring(4);
        }
        else
        {
            phoneNumberInput = "";
        }

        showAddForm = true;
        showDetailsModal = false;
        StateHasChanged();
    }

    private async Task SaveEmployee()
    {
        bool success;
        string action;

        // Update full name before saving
        currentEmployee.UpdateFullName();

        if (editingEmployee != null)
        {
            editingEmployee.LastName = currentEmployee.LastName;
            editingEmployee.FirstName = currentEmployee.FirstName;
            editingEmployee.MiddleName = currentEmployee.MiddleName;
            editingEmployee.Suffix = currentEmployee.Suffix;
            editingEmployee.FullName = currentEmployee.FullName;
            editingEmployee.EmployeeCode = currentEmployee.EmployeeCode;
            editingEmployee.Email = currentEmployee.Email;
            editingEmployee.PhoneNumber = currentEmployee.PhoneNumber;
            editingEmployee.Position = currentEmployee.Position;
            editingEmployee.Department = currentEmployee.Department;
            editingEmployee.Status = currentEmployee.Status;

            success = await ManpowerService.UpdateEmployeeAsync(editingEmployee);
            action = "updated";
        }
        else
        {
            success = await ManpowerService.AddEmployeeAsync(currentEmployee);
            action = "added";
        }

        if (success)
        {
            await LoadEmployees();
            var employeeName = currentEmployee.FullName;
            CancelForm();
            StateHasChanged();
            await ShowToast("success", $"Employee {action.Substring(0, 1).ToUpper() + action.Substring(1)}!", $"{employeeName} has been successfully {action}.");
        }
        else
        {
            await ShowToast("error", "Error", $"Failed to save employee. Please try again.");
        }
    }

    private void ShowDeleteConfirmation(Employee employee)
    {
        employeeToDelete = employee;
        showDeleteConfirmation = true;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        employeeToDelete = null;
        showDeleteConfirmation = false;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (employeeToDelete != null)
        {
            var employeeName = employeeToDelete.FullName;
            await ManpowerService.DeleteEmployeeAsync(employeeToDelete.EmployeeId);
            await LoadEmployees();
            CancelDelete();
            await ShowToast("info", "Employee Deleted", $"{employeeName} has been removed from the system.");
        }
    }

    private void CancelForm()
    {
        showAddForm = false;
        currentEmployee = new Employee();
        editingEmployee = null;
    }

    private async Task ViewEmployeeDetails(Employee employee)
    {
        selectedEmployee = employee;
        showDetailsModal = true;
        isLoadingSchedules = true;
        StateHasChanged();

        // Load employee schedules
        try
        {
            employeeSchedules = await ManpowerService.GetSchedulesByEmployeeAsync(employee.EmployeeId);
        }
        catch
        {
            employeeSchedules = new List<Schedule>();
        }
        finally
        {
            isLoadingSchedules = false;
            StateHasChanged();
        }
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedEmployee = null;
        employeeSchedules = new List<Schedule>();
        StateHasChanged();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Active" => "bg-success",
            "On Leave" => "bg-warning text-dark",
            "Inactive" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    // Filter methods
    private void ApplyFilters()
    {
        var filtered = employees.AsEnumerable();

        if (!string.IsNullOrEmpty(searchText))
        {
            filtered = filtered.Where(e =>
                e.FullName.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                e.EmployeeCode.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (e.Position != null && e.Position.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            );
        }

        if (!string.IsNullOrEmpty(selectedDepartment))
        {
            filtered = filtered.Where(e => e.Department == selectedDepartment);
        }

        if (!string.IsNullOrEmpty(selectedStatus))
        {
            filtered = filtered.Where(e => e.Status == selectedStatus);
        }

        filteredEmployees = filtered.ToList();
        currentPage = 1; // Reset to first page when filters change
        ApplyPagination();
        StateHasChanged();
    }

    private Task OnDepartmentFilterChanged(ChangeEventArgs e)
    {
        selectedDepartment = e?.Value?.ToString() ?? "";
        ApplyFilters();
        return Task.CompletedTask;
    }

    private Task OnStatusFilterChanged(ChangeEventArgs e)
    {
        selectedStatus = e?.Value?.ToString() ?? "";
        ApplyFilters();
        return Task.CompletedTask;
    }

    private void ClearFilters()
    {
        searchText = string.Empty;
        selectedDepartment = string.Empty;
        selectedStatus = string.Empty;
        ApplyFilters();
    }

    private List<string> GetAllDepartments()
    {
        return employees.Select(e => e.Department).Distinct().OrderBy(d => d).ToList();
    }

    // Employee Code Generation
    private void GenerateEmployeeCode()
    {
        var year = DateTime.Now.Year;
        var count = employees.Count + 1;
        currentEmployee.EmployeeCode = $"EMP-{year}-{count:D3}";
        StateHasChanged();
    }

    // Update Full Name from separate fields
    private void UpdateEmployeeFullName()
    {
        currentEmployee.UpdateFullName();
    }

    // Validation methods

    // 1. Name Validation (Last, First, Middle) - Letters and spaces only
    private bool IsValidName(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return true; // Allow empty for optional fields

        // Must contain at least one letter
        if (!name.Any(char.IsLetter))
            return false;

        // Only letters and spaces allowed
        return name.All(c => char.IsLetter(c) || char.IsWhiteSpace(c));
    }

    // 2. Employee Code Validation - Alphanumeric and hyphens only
    private bool IsValidEmployeeCode(string? code)
    {
        if (string.IsNullOrWhiteSpace(code))
            return false;

        // Must contain letters and numbers
        if (!code.Any(char.IsLetterOrDigit))
            return false;

        // Only letters, numbers, and hyphens allowed
        return code.All(c => char.IsLetterOrDigit(c) || c == '-');
    }

    // 3. Enhanced Email Validation
    private bool IsValidEmail(string? email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return true; // Optional field

        var atIndex = email.IndexOf('@');
        var dotIndex = email.LastIndexOf('.');

        if (atIndex < 0 || dotIndex < 0 || atIndex >= dotIndex)
            return false;

        var localPart = email.Substring(0, atIndex);
        var domainPart = email.Substring(atIndex + 1, dotIndex - atIndex - 1);
        var extension = email.Substring(dotIndex + 1);

        if (localPart.Length < 3 || domainPart.Length < 3)
            return false;

        if (!extension.Equals("com", StringComparison.OrdinalIgnoreCase))
            return false;

        if (email.Contains(" "))
            return false;

        return localPart.All(c => char.IsLetterOrDigit(c) || c == '.' || c == '_' || c == '-') &&
               domainPart.All(c => char.IsLetterOrDigit(c) || c == '.' || c == '-');
    }

    // 4. Philippine Phone Number Validation
    private bool IsValidPhoneNumber(string? phoneNumber)
    {
        if (string.IsNullOrWhiteSpace(phoneNumber))
            return true; // Optional field

        var cleaned = phoneNumber.Replace(" ", "");

        if (!cleaned.StartsWith("+63"))
            return false;

        var number = cleaned.Substring(3);

        if (number.Length != 10)
            return false;

        if (!number.StartsWith("9"))
            return false;

        return number.All(char.IsDigit);
    }

    // 5. Position Validation - Letters with numbers and spaces allowed
    private bool IsValidPosition(string? position)
    {
        if (string.IsNullOrWhiteSpace(position))
            return false;

        // Must contain at least one letter
        if (!position.Any(char.IsLetter))
            return false;

        // Letters, numbers, and spaces allowed
        return position.All(c => char.IsLetterOrDigit(c) || char.IsWhiteSpace(c));
    }

    // 6. Department Validation - Letters and spaces only
    private bool IsValidDepartment(string? department)
    {
        if (string.IsNullOrWhiteSpace(department))
            return false;

        // Must contain at least one letter
        if (!department.Any(char.IsLetter))
            return false;

        // Only letters and spaces allowed
        return department.All(c => char.IsLetter(c) || char.IsWhiteSpace(c));
    }

    // Phone Input Handler (from Supplier validation)
    private void HandlePhoneInput(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? "";
        var cleaned = new string(input.Where(c => char.IsDigit(c) || c == ' ').ToArray());

        if (cleaned.Replace(" ", "").Length > 10)
        {
            cleaned = string.Join("", cleaned.Where(char.IsDigit).Take(10));
        }

        var digitsOnly = new string(cleaned.Where(char.IsDigit).ToArray());
        if (digitsOnly.Length > 0)
        {
            if (digitsOnly.Length <= 3)
                phoneNumberInput = digitsOnly;
            else if (digitsOnly.Length <= 6)
                phoneNumberInput = $"{digitsOnly.Substring(0, 3)} {digitsOnly.Substring(3)}";
            else
                phoneNumberInput = $"{digitsOnly.Substring(0, 3)} {digitsOnly.Substring(3, 3)} {digitsOnly.Substring(6)}";
        }
        else
        {
            phoneNumberInput = "";
        }

        if (!string.IsNullOrWhiteSpace(phoneNumberInput))
            currentEmployee.PhoneNumber = "+63 " + phoneNumberInput;
        else
            currentEmployee.PhoneNumber = "";

        StateHasChanged();
    }

    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(currentEmployee.LastName) &&
               IsValidName(currentEmployee.LastName) &&
               !string.IsNullOrWhiteSpace(currentEmployee.FirstName) &&
               IsValidName(currentEmployee.FirstName) &&
               (string.IsNullOrWhiteSpace(currentEmployee.MiddleName) || IsValidName(currentEmployee.MiddleName)) &&
               !string.IsNullOrWhiteSpace(currentEmployee.EmployeeCode) &&
               IsValidEmployeeCode(currentEmployee.EmployeeCode) &&
               !string.IsNullOrWhiteSpace(currentEmployee.Position) &&
               IsValidPosition(currentEmployee.Position) &&
               !string.IsNullOrWhiteSpace(currentEmployee.Department) &&
               IsValidDepartment(currentEmployee.Department) &&
               (string.IsNullOrWhiteSpace(currentEmployee.Email) || IsValidEmail(currentEmployee.Email)) &&
               (string.IsNullOrWhiteSpace(currentEmployee.PhoneNumber) || IsValidPhoneNumber(currentEmployee.PhoneNumber));
    }

    // CSS class helper methods
    private string GetLastNameClass()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.LastName))
            return "form-control form-control-sm ";

        return IsValidName(currentEmployee.LastName)
            ? "form-control form-control-sm"
            : "form-control form-control-sm is-invalid";


    }

    private string GetFirstNameClass()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.FirstName))
            return "form-control form-control-sm";

        return IsValidName(currentEmployee.FirstName)
            ? "form-control form-control-sm"
            : "form-control form-control-sm is-invalid";
    }

    private string GetMiddleNameClass()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.MiddleName))
            return "form-control form-control-sm";

        return IsValidName(currentEmployee.MiddleName)
            ? "form-control form-control-sm"
            : "form-control form-control-sm is-invalid";
    }

    private string GetEmployeeCodeClass()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.EmployeeCode))
            return "form-control form-control-sm is-invalid";

        return IsValidEmployeeCode(currentEmployee.EmployeeCode)
            ? "form-control form-control-sm"
            : "form-control form-control-sm is-invalid";
    }

    private string GetPositionClass()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.Position))
            return "form-control form-control-sm ";

        return IsValidPosition(currentEmployee.Position)
            ? "form-control form-control-sm"
            : "form-control form-control-sm is-invalid";
    }

    private string GetDepartmentClass()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.Department))
            return "form-control form-control-sm ";

        return IsValidDepartment(currentEmployee.Department)
            ? "form-control form-control-sm"
            : "form-control form-control-sm is-invalid";
    }

    private string GetEmailClass()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.Email))
            return "form-control form-control-sm";

        return IsValidEmail(currentEmployee.Email)
            ? "form-control form-control-sm"
            : "form-control form-control-sm is-invalid";
    }

    private string GetPhoneNumberClass()
    {
        if (string.IsNullOrWhiteSpace(currentEmployee.PhoneNumber))
            return "form-control form-control-sm";

        return IsValidPhoneNumber(currentEmployee.PhoneNumber)
            ? "form-control form-control-sm"
            : "form-control form-control-sm is-invalid";
    }

    // Helper methods for details modal
    private string GetInitials(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "??";

        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1)
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();

        return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
    }

    private string CalculateTenure(DateTime dateHired)
    {
        var tenure = DateTime.Now - dateHired;
        var years = tenure.Days / 365;
        var months = (tenure.Days % 365) / 30;

        if (years > 0)
            return $"{years} year{(years > 1 ? "s" : "")} {months} month{(months != 1 ? "s" : "")}";
        else if (months > 0)
            return $"{months} month{(months != 1 ? "s" : "")}";
        else
            return $"{tenure.Days} day{(tenure.Days != 1 ? "s" : "")}";
    }

    // Sorting methods
    private void SortBy(string column)
    {
        if (currentSortColumn == column)
        {
            isSortAscending = !isSortAscending;
        }
        else
        {
            currentSortColumn = column;
            isSortAscending = true;
        }

        filteredEmployees = column switch
        {
            "Code" => isSortAscending
                ? filteredEmployees.OrderBy(e => e.EmployeeCode).ToList()
                : filteredEmployees.OrderByDescending(e => e.EmployeeCode).ToList(),
            "Name" => isSortAscending
                ? filteredEmployees.OrderBy(e => e.FullName).ToList()
                : filteredEmployees.OrderByDescending(e => e.FullName).ToList(),
            "Position" => isSortAscending
                ? filteredEmployees.OrderBy(e => e.Position).ToList()
                : filteredEmployees.OrderByDescending(e => e.Position).ToList(),
            "Department" => isSortAscending
                ? filteredEmployees.OrderBy(e => e.Department).ToList()
                : filteredEmployees.OrderByDescending(e => e.Department).ToList(),
            _ => filteredEmployees
        };

        ApplyPagination();
        StateHasChanged();
    }

    private string GetSortIcon(string column)
    {
        if (currentSortColumn != column)
            return "↕️";

        return isSortAscending ? "↑" : "↓";
    }

    // Toast notification method
    private async Task ShowToast(string type, string title, string message)
    {
        try
        {
            var toastType = type switch
            {
                "success" => "success",
                "error" => "danger",
                "info" => "info",
                "warning" => "warning",
                _ => "info"
            };

            await JSRuntime.InvokeVoidAsync("showToast", toastType, title, message);
        }
        catch
        {
            // Toast failed, but operation was successful
        }
    }

    // Pagination methods
    private void ApplyPagination()
    {
        totalPages = (int)Math.Ceiling(filteredEmployees.Count / (double)pageSize);

        if (currentPage > totalPages && totalPages > 0)
            currentPage = totalPages;

        if (currentPage < 1)
            currentPage = 1;

        var skip = (currentPage - 1) * pageSize;
        paginatedEmployees = filteredEmployees.Skip(skip).Take(pageSize).ToList();
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            ApplyPagination();
            StateHasChanged();
        }
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            ApplyPagination();
            StateHasChanged();
        }
    }

    private Task OnPageSizeChanged(ChangeEventArgs e)
    {
        pageSize = int.Parse(e?.Value?.ToString() ?? "10");
        currentPage = 1;
        ApplyPagination();
        StateHasChanged();
        return Task.CompletedTask;
    }

}
