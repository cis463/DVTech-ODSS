@page "/purchase-orders"
@using DVTech_ODSS.Models
@using DVTech_ODSS.Services
@inject ProcurementService ProcurementService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject AuthStateProvider AuthState
@rendermode InteractiveServer

<PageTitle>Purchase Orders</PageTitle>

<div class="container-fluid">
    <div class="row mb-3 align-items-center">
        <div class="col">
            <h3 class="mb-0">🛒 Purchase Orders</h3>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowCreateForm">
                ➕ Create New Order
            </button>
        </div>
    </div>

    <!-- Status Filter Tabs -->
    <!-- SUMMARY CARDS - USE THE SPACE FROM REMOVED PILLS -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="card shadow-sm border-warning">
                <div class="card-body p-3">
                    <p class="text-muted small mb-1">⏳ Pending</p>
                    <h4 class="mb-0 text-warning">@allOrders.Count(o => o.Status == "Pending")</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-info">
                <div class="card-body p-3">
                    <p class="text-muted small mb-1">✅ Approved</p>
                    <h4 class="mb-0 text-info">@allOrders.Count(o => o.Status == "Approved")</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-primary">
                <div class="card-body p-3">
                    <p class="text-muted small mb-1">📦 Ordered</p>
                    <h4 class="mb-0 text-primary">@allOrders.Count(o => o.Status == "Ordered")</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-success">
                <div class="card-body p-3">
                    <p class="text-muted small mb-1">🚚 Delivered</p>
                    <h4 class="mb-0 text-success">@allOrders.Count(o => o.Status == "Delivered")</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Date Filters -->
    <div class="card shadow-sm mb-3">
    <div class="card shadow-sm mb-3">
        <div class="card-body p-2">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <label class="form-label small mb-0 fw-bold">Filter by:</label>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Order Created Date</label>
                    <input type="date"
                           class="form-control form-control-sm"
                           @bind="filterCreatedDate"
                           @bind:event="oninput"
                           @onchange="ApplyFilters" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Delivered Date</label>
                    <input type="date"
                           class="form-control form-control-sm"
                           @bind="filterDeliveredDate"
                           @bind:event="oninput"
                           @onchange="ApplyFilters" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Search Order #</label>
                    <input type="text"
                           class="form-control form-control-sm"
                           placeholder="🔍 Search..."
                           @bind="searchText"
                           @bind:event="oninput"
                           @onkeyup="ApplyFilters" />
                </div>
                <div class="col-auto">
                    <label class="form-label small mb-1">&nbsp;</label>
                    <button class="btn btn-sm btn-outline-secondary d-block" @onclick="ClearFilters">
                        Clear Filters
                    </button>
                </div>
                <div class="col text-end">
                    <label class="form-label small mb-1">&nbsp;</label>
                    <div>
                        <span class="badge bg-info">Showing @displayedOrders.Count of @allOrders.Count orders</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (showCreateForm)
    {
        <!-- CREATE ORDER FORM -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0">Create New Purchase Order</h6>
            </div>
            <div class="card-body p-3">
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold mb-1">Select Supplier *</label>
                        <select class="form-select" @onchange="OnSupplierSelected" value="@selectedSupplierId">
                            <option value="0">-- Choose a Supplier --</option>
                            @foreach (var supplier in suppliers)
                            {
                                <option value="@supplier.SupplierId">@supplier.SupplierName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold mb-1">Expected Delivery</label>
                        <input type="date" class="form-control" @bind="expectedDeliveryDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold mb-1">Items Selected</label>
                        <input type="text" class="form-control text-center fw-bold" value="@orderItems.Count" readonly />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold mb-1">Notes (Optional)</label>
                    <textarea class="form-control form-control-sm" rows="2" @bind="orderNotes" placeholder="Special instructions..."></textarea>
                </div>

                @if (selectedSupplierId > 0)
                {
                    <hr class="my-3" />
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Available Items from @selectedSupplierName</h6>
                        <small class="text-muted">Enter quantity for items to order</small>
                    </div>

                    @if (supplierItems.Any())
                    {
                        <div class="row g-2">
                            @foreach (var item in supplierItems)
                            {
                                var orderItem = orderItems.FirstOrDefault(oi => oi.SupplierItemId == item.SupplierItemId);
                                var quantity = orderItem?.Quantity ?? 0;
                                var unitPrice = orderItem?.UnitPrice ?? item.PricePerUnit;

                                <div class="col-md-4 col-lg-3">
                                    <div class="card h-100 @(quantity > 0 ? "border-primary shadow-sm" : "")">
                                        <div class="card-body p-2">
                                            <h6 class="card-title mb-1 small">@item.ItemName</h6>
                                            <p class="card-text mb-2" style="font-size: 0.75rem; color: #6c757d;">
                                                <strong>@item.Brand</strong><br />
                                                @item.Category • ₱@item.PricePerUnit.ToString("N2")/@item.Unit
                                            </p>

                                            <div class="row g-1">
                                                <div class="col-7">
                                                    <label class="form-label mb-0" style="font-size: 0.7rem;">Qty</label>
                                                    <input type="number"
                                                           class="form-control form-control-sm"
                                                           min="0"
                                                           value="@quantity"
                                                           @onchange="@(e => UpdateItemQuantity(item, e.Value?.ToString()))" />
                                                </div>
                                                <div class="col-5">
                                                    <label class="form-label mb-0" style="font-size: 0.7rem;">Price</label>
                                                    <input type="number"
                                                           class="form-control form-control-sm"
                                                           step="0.01"
                                                           min="0"
                                                           value="@unitPrice"
                                                           @onchange="@(e => UpdateItemPrice(item.SupplierItemId, e.Value?.ToString()))" />
                                                </div>
                                            </div>

                                            @if (quantity > 0)
                                            {
                                                <div class="mt-2 pt-2 border-top">
                                                    <small class="text-primary fw-bold">₱@((quantity * unitPrice).ToString("N2"))</small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="card mt-3 bg-light border-0">
                            <div class="card-body p-2">
                                <div class="row align-items-center">
                                    <div class="col-6">
                                        <div class="small">
                                            <strong>Items:</strong> @orderItems.Count
                                            <span class="text-muted ms-2">Qty:</span> @orderItems.Sum(oi => oi.Quantity)
                                        </div>
                                    </div>
                                    <div class="col-6 text-end">
                                        <h5 class="text-success mb-0">₱@CalculateTotalAmount().ToString("N2")</h5>
                                        <small class="text-muted">Total Amount</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning py-2 small mb-0">
                            This supplier has no items in their catalog. Please add items to the supplier first.
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning py-2 small mb-0">
                        Please select a supplier to view available items.
                    </div>
                }

                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-success"
                            @onclick="CreateOrder"
                            disabled="@(!CanCreateOrder())">
                        Create Order
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="CancelForm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- ORDERS LIST -->
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="py-2">Order #</th>
                                <th class="py-2">Supplier</th>
                                <th class="py-2">Order Date</th>
                                <th class="py-2">Expected Delivery</th>
                                <th class="py-2 text-center">Items</th>
                                <th class="py-2 text-end">Total</th>
                                    <th class="py-2 text-center">
                                        <select class="form-select form-select-sm d-inline-block w-auto"
                                                @onchange="OnStatusFilterChanged"
                                                style="font-size: 0.875rem;">
                                            <option value="">Status ▼</option>
                                            <option value="Pending">Pending</option>
                                            <option value="Approved">Approved</option>
                                            <option value="Ordered">Ordered</option>
                                            <option value="Delivered">Delivered</option>
                                            <option value="Cancelled">Cancelled</option>
                                        </select>
                                    </th>
                                <th class="py-2 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (displayedOrders.Any())
                            {
                                @foreach (var order in displayedOrders)
                                {
                                    <tr style="cursor: pointer;" @onclick="() => ViewOrderDetails(order)">
                                        <td class="py-2"><strong class="small">@order.OrderNumber</strong></td>
                                        <td class="py-2 small">@order.Supplier?.SupplierName</td>
                                        <td class="py-2 small">@order.CreatedDate.ToString("MMM dd, yyyy")</td>
                                        <td class="py-2 small">@(order.ExpectedDeliveryDate?.ToString("MMM dd, yyyy") ?? "-")</td>
                                        <td class="py-2 text-center small">@order.OrderItems.Count</td>
                                        <td class="py-2 text-end small"><strong>₱@order.TotalAmount.ToString("N2")</strong></td>
                                        <td class="py-2 text-center">
                                            <span class="badge @GetStatusBadgeClass(order.Status) small">
                                                @order.Status
                                            </span>
                                        </td>
                                          
                                            <td class="py-2 text-center" @onclick:stopPropagation="true">
                                                @if (AuthState.IsAdmin)
                                                {
                                                    @* Admin can perform all actions *@
                                                    @if (order.Status == "Pending")
                                                    {
                                                        <button class="btn btn-success btn-sm py-0 px-2 me-1" @onclick='() => ShowStatusConfirmation(order, "Approved")'>Approve</button>
                                                        <button class="btn btn-danger btn-sm py-0 px-2" @onclick='() => ShowStatusConfirmation(order, "Cancelled")'>Cancel</button>
                                                    }
                                                    else if (order.Status == "Approved")
                                                    {
                                                        <button class="btn btn-primary btn-sm py-0 px-2 me-1" @onclick='() => ShowStatusConfirmation(order, "Ordered")'>Order</button>
                                                        <button class="btn btn-danger btn-sm py-0 px-2" @onclick='() => ShowStatusConfirmation(order, "Cancelled")'>Cancel</button>
                                                    }
                                                    else if (order.Status == "Ordered")
                                                    {
                                                        <button class="btn btn-info btn-sm py-0 px-2 me-1" @onclick='() => ShowStatusConfirmation(order, "Delivered")'>Deliver</button>
                                                        <button class="btn btn-danger btn-sm py-0 px-2" @onclick='() => ShowStatusConfirmation(order, "Cancelled")'>Cancel</button>
                                                    }
                                                    else if (order.Status == "Cancelled")
                                                    {
                                                        <span class="badge bg-danger">Cancelled</span>
                                                    }
                                                    else if (order.Status == "Delivered")
                                                    {
                                                        <span class="badge bg-success">✓ Delivered</span>
                                                    }
                                                }
                                                else
                                                {
                                                    @* Secretary can only view status *@
                                                    @if (order.Status == "Pending")
                                                    {
                                                        <span class="badge bg-warning text-dark">⏳ Awaiting Approval</span>
                                                    }
                                                    else if (order.Status == "Approved")
                                                    {
                                                        <span class="badge bg-info">✅ Approved</span>
                                                    }
                                                    else if (order.Status == "Ordered")
                                                    {
                                                        <span class="badge bg-primary">📦 Ordered</span>
                                                    }
                                                    else if (order.Status == "Delivered")
                                                    {
                                                        <span class="badge bg-success">✓ Delivered</span>
                                                    }
                                                    else if (order.Status == "Cancelled")
                                                    {
                                                        <span class="badge bg-danger">❌ Cancelled</span>
                                                    }
                                                }
                                            </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-muted">
                                        No purchase orders found.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    </div>
    <!-- STATUS CHANGE CONFIRMATION MODAL -->
    @if (showStatusConfirmation && orderToUpdate != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.7);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header py-2 @GetConfirmationHeaderClass(targetStatus)">
                        <h6 class="modal-title mb-0 text-white">
                            @GetConfirmationIcon(targetStatus) Confirm Status Change
                        </h6>
                    </div>
                    <div class="modal-body p-3">
                        <p class="mb-2">Are you sure you want to change the status of this Order to:</p>
                        <div class="alert @GetConfirmationAlertClass(targetStatus) py-2 mb-3">
                            <strong>@targetStatus</strong>
                        </div>

                        <div class="card bg-light border-0 mb-3">
                            <div class="card-body p-2">
                                <p class="small mb-1"><strong>Order:</strong> @orderToUpdate.OrderNumber</p>
                                <p class="small mb-1"><strong>Supplier:</strong> @orderToUpdate.Supplier?.SupplierName</p>
                                <p class="small mb-0"><strong>Total:</strong> ₱@orderToUpdate.TotalAmount.ToString("N2")</p>
                            </div>
                        </div>

                        @if (targetStatus == "Delivered")
                        {
                            <div class="alert alert-info py-2 small mb-0">
                                <strong>📦 Note:</strong> Items will be automatically added to inventory when delivered.
                            </div>
                        }
                        else if (targetStatus == "Cancelled")
                        {
                            <div class="alert alert-danger py-2 small mb-0">
                                <strong>⚠️ Warning:</strong> This action cannot be undone. The order will be permanently cancelled.
                            </div>
                        }
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-sm btn-secondary" @onclick="CancelStatusChange">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-sm @GetConfirmationButtonClass(targetStatus)" @onclick="ConfirmStatusChange">
                            Yes, @targetStatus
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Order Details Modal -->
@if (showDetailsModal && selectedOrder != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title mb-0">Purchase Order Details</h6>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseDetailsModal"></button>
                </div>                
                <div class="modal-body p-3">
                    <div class="row mb-3">
                        <div class="col-8">
                            <h5 class="mb-1">@selectedOrder.OrderNumber</h5>
                            <p class="text-muted small mb-0">
                                <strong>Supplier:</strong> @selectedOrder.Supplier?.SupplierName
                            </p>
                            <p class="text-muted small mb-0">
                                <strong>Created by:</strong> @selectedOrder.CreatedBy
                            </p>
                        </div>
                        <div class="col-4 text-end">
                            <span class="badge @GetStatusBadgeClass(selectedOrder.Status) px-3 py-2">
                                @selectedOrder.Status
                            </span>
                        </div>
                    </div>

                    <div class="modal-body p-3">
                        <!-- Full Width Timeline -->
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-secondary text-white py-2">
                                <h6 class="mb-0 text-center">📋 Order Timeline</h6>
                            </div>
                            <div class="card-body p-4">
                                <!-- Timeline content stays the same -->
                                            <!-- Created -->
                                            <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                                         style="width: 36px; height: 36px; font-size: 14px;">
                                                        ✓
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0 small fw-bold">Created</h6>
                                                    <p class="text-muted small mb-0">@selectedOrder.CreatedDate.ToString("MMM dd, yyyy hh:mm tt")</p>
                                                    <p class="text-muted small mb-0">By: @selectedOrder.CreatedBy</p>
                                                </div>
                                            </div>

                                            <!-- Approved -->
                                            <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="rounded-circle @(selectedOrder.ApprovedDate.HasValue ? "bg-info" : "bg-light border") text-white d-flex align-items-center justify-content-center"
                                                         style="width: 36px; height: 36px; font-size: 14px;">
                                                        @(selectedOrder.ApprovedDate.HasValue ? "✓" : "○")
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0 small fw-bold">Approved</h6>
                                                    @if (selectedOrder.ApprovedDate.HasValue)
                                                    {
                                                        <p class="text-muted small mb-0">@selectedOrder.ApprovedDate.Value.ToString("MMM dd, yyyy hh:mm tt")</p>
                                                        <p class="text-muted small mb-0">By: @(selectedOrder.ApprovedBy ?? "N/A")</p>
                                                    }
                                                    else
                                                    {
                                                        <p class="text-muted small mb-0 fst-italic">Pending approval</p>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Ordered -->
                                            <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="rounded-circle @(selectedOrder.OrderedDate.HasValue ? "bg-primary" : "bg-light border") text-white d-flex align-items-center justify-content-center"
                                                         style="width: 36px; height: 36px; font-size: 14px;">
                                                        @(selectedOrder.OrderedDate.HasValue ? "✓" : "○")
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0 small fw-bold">Ordered</h6>
                                                    @if (selectedOrder.OrderedDate.HasValue)
                                                    {
                                                        <p class="text-muted small mb-0">@selectedOrder.OrderedDate.Value.ToString("MMM dd, yyyy hh:mm tt")</p>
                                                        <p class="text-muted small mb-0">By: @(selectedOrder.OrderedBy ?? "N/A")</p>
                                                    }
                                                    else
                                                    {
                                                        <p class="text-muted small mb-0 fst-italic">Not yet ordered</p>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Delivered -->
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="rounded-circle @(selectedOrder.DeliveredDate.HasValue ? "bg-success" : "bg-light border") text-white d-flex align-items-center justify-content-center"
                                                         style="width: 36px; height: 36px; font-size: 14px;">
                                                        @(selectedOrder.DeliveredDate.HasValue ? "✓" : "○")
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0 small fw-bold">Delivered</h6>
                                                    @if (selectedOrder.DeliveredDate.HasValue)
                                                    {
                                                        <p class="text-muted small mb-0">@selectedOrder.DeliveredDate.Value.ToString("MMM dd, yyyy hh:mm tt")</p>
                                                        <p class="text-muted small mb-0">By: @(selectedOrder.DeliveredBy ?? "N/A")</p>
                                                        <span class="badge bg-success small mt-1">✓ Inventory Updated</span>
                                                    }
                                                    else
                                                    {
                                                        <p class="text-muted small mb-0 fst-italic">Not yet delivered</p>
                                                    }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(selectedOrder.Notes))
                    {
                        <div class="alert alert-info py-2 small mb-3">
                            <strong>Notes:</strong> @selectedOrder.Notes
                        </div>
                    }

                    <h6 class="mb-2">Order Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="py-1 small">Item Name</th>
                                    <th class="py-1 small">Brand</th>
                                    <th class="py-1 small">Category</th>
                                    <th class="py-1 text-end small">Quantity</th>
                                    <th class="py-1 text-end small">Unit Price</th>
                                    <th class="py-1 text-end small">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in selectedOrder.OrderItems)
                                {
                                    <tr>
                                        <td class="py-1 small">@item.ItemName</td>
                                        <td class="py-1 small">@item.Brand</td>
                                        <td class="py-1 small">@item.Category</td>
                                        <td class="py-1 text-end small">@item.Quantity @item.Unit</td>
                                        <td class="py-1 text-end small">₱@item.UnitPrice.ToString("N2")</td>
                                        <td class="py-1 text-end small"><strong>₱@item.TotalPrice.ToString("N2")</strong></td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="5" class="py-2 text-end small"><strong>Grand Total:</strong></td>
                                    <td class="py-2 text-end"><strong class="text-success">₱@selectedOrder.TotalAmount.ToString("N2")</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-secondary" @onclick="CloseDetailsModal">Close</button>
                </div>
            </div>
        </div>

    </div>   
}

@code {
    
    private List<PurchaseOrder> allOrders = new();
    private List<PurchaseOrder> displayedOrders = new();
    private List<Supplier> suppliers = new();
    private List<SupplierItem> supplierItems = new();
    private List<PurchaseOrderItem> orderItems = new();

    private string filterStatus = string.Empty; // Add this line
    private PurchaseOrder? selectedOrder = null;
    private bool showCreateForm = false;
    private bool showDetailsModal = false;
    private bool isLoading = true;
    private DateTime? filterCreatedDate = null;
    private DateTime? filterDeliveredDate = null;
    private string searchText = string.Empty;
    private bool showStatusConfirmation = false;
    private PurchaseOrder? orderToUpdate = null;
    private string targetStatus = string.Empty;

    // Form fields
    private int selectedSupplierId = 0;
    private string selectedSupplierName = string.Empty;
    private DateTime? expectedDeliveryDate = null;
    private string orderNotes = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();

        // Check for query parameters from inventory navigation
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        var supplierIdParam = query["supplierId"];
        var autoCreateParam = query["autoCreate"];

        if (!string.IsNullOrEmpty(supplierIdParam) && int.TryParse(supplierIdParam, out int supplierId))
        {
            // Auto-select supplier and open create form
            selectedSupplierId = supplierId;
            var selectedSupplier = suppliers.FirstOrDefault(s => s.SupplierId == supplierId);

            if (selectedSupplier != null)
            {
                selectedSupplierName = selectedSupplier.SupplierName;
                supplierItems = selectedSupplier.SupplierItems.Where(si => si.IsActive).ToList();

                // Auto-open create form if autoCreate=true
                if (autoCreateParam == "true")
                {
                    ShowCreateForm();
                    StateHasChanged();
                }
            }
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        allOrders = await ProcurementService.GetAllPurchaseOrdersAsync();
        suppliers = await ProcurementService.GetAllSuppliersAsync();
        isLoading = false;
        ApplyFilters(); 
    }

    private void ShowCreateForm()
    {
        // Only reset supplier if not already selected (for auto-navigation)
        if (selectedSupplierId == 0)
        {
            selectedSupplierName = string.Empty;
            supplierItems = new();
        }

        expectedDeliveryDate = DateTime.Now.AddDays(7);
        orderNotes = string.Empty;
        orderItems = new();
        showCreateForm = true;
    }

    private async Task OnSupplierSelected(ChangeEventArgs e)
    {
        selectedSupplierId = int.Parse(e.Value?.ToString() ?? "0");

        if (selectedSupplierId > 0)
        {
            var selectedSupplier = suppliers.FirstOrDefault(s => s.SupplierId == selectedSupplierId);
            selectedSupplierName = selectedSupplier?.SupplierName ?? "";
            supplierItems = selectedSupplier?.SupplierItems.Where(si => si.IsActive).ToList() ?? new();
            orderItems = new();
        }
        else
        {
            selectedSupplierName = string.Empty;
            supplierItems = new();
            orderItems = new();
        }

        StateHasChanged();
    }

    private void UpdateItemQuantity(SupplierItem supplierItem, string? quantityStr)
    {
        if (!int.TryParse(quantityStr, out int quantity) || quantity < 0)
            return;

        var existingItem = orderItems.FirstOrDefault(oi => oi.SupplierItemId == supplierItem.SupplierItemId);

        if (quantity == 0)
        {
            if (existingItem != null)
                orderItems.Remove(existingItem);
        }
        else
        {
            if (existingItem != null)
            {
                existingItem.Quantity = quantity;
            }
            else
            {
                orderItems.Add(new PurchaseOrderItem
                {
                    SupplierItemId = supplierItem.SupplierItemId,
                    ItemName = supplierItem.ItemName,
                    Brand = supplierItem.Brand,
                    Category = supplierItem.Category,
                    Unit = supplierItem.Unit,
                    Quantity = quantity,
                    UnitPrice = supplierItem.PricePerUnit
                });
            }
        }

        StateHasChanged();
    }

    private void UpdateItemPrice(int supplierItemId, string? priceStr)
    {
        if (!decimal.TryParse(priceStr, out decimal price) || price < 0)
            return;

        var existingItem = orderItems.FirstOrDefault(oi => oi.SupplierItemId == supplierItemId);
        if (existingItem != null)
        {
            existingItem.UnitPrice = price;
            StateHasChanged();
        }
    }

    private decimal CalculateTotalAmount()
    {
        return orderItems.Sum(oi => oi.TotalPrice);
    }

    private bool CanCreateOrder()
    {
        return selectedSupplierId > 0 && orderItems.Any() && orderItems.All(oi => oi.Quantity > 0 && oi.UnitPrice > 0);
    }

    private async Task CreateOrder()
    {
        if (!CanCreateOrder())
            return;

        var newOrder = new PurchaseOrder
        {
            SupplierId = selectedSupplierId,
            ExpectedDeliveryDate = expectedDeliveryDate,
            Notes = orderNotes,
            OrderItems = orderItems.ToList(),
            TotalAmount = CalculateTotalAmount(),
            CreatedBy = AuthState.CurrentUser?.FullName ?? "Unknown"  // Add this line
        };

        var success = await ProcurementService.AddPurchaseOrderAsync(newOrder);

        if (success)
        {
            await LoadData();
            CancelForm();

            // Different messages based on role
            if (AuthState.IsSecretary)
            {
                await ShowToast("success", "Order Created!", "Purchase order submitted for admin approval.");
            }
            else
            {
                await ShowToast("success", "Order Created!", "Purchase order has been created successfully.");
            }
        }
        else
        {
            await ShowToast("error", "Error", "Failed to create purchase order.");
        }
    }

    private async Task UpdateStatus(int orderId, string newStatus)
    {
        var success = await ProcurementService.UpdateOrderStatusAsync(orderId, newStatus);

        if (success)
        {
            await LoadData();

            if (newStatus == "Delivered")
            {
                await ShowToast("success", "Order Delivered!", "Items have been added to inventory automatically.");
            }
            else
            {
                await ShowToast("info", "Status Updated", $"Order status changed to {newStatus}.");
            }
        }
    }

    // NEW: Show confirmation dialog
    private void ShowStatusConfirmation(PurchaseOrder order, string newStatus)
    {
        orderToUpdate = order;
        targetStatus = newStatus;
        showStatusConfirmation = true;
        StateHasChanged();
    }

    // NEW: Cancel status change
    private void CancelStatusChange()
    {
        orderToUpdate = null;
        targetStatus = string.Empty;
        showStatusConfirmation = false;
        StateHasChanged();
    }

    // NEW: Confirm and execute status change
    private async Task ConfirmStatusChange()
    {
        if (orderToUpdate != null)
        {
            showStatusConfirmation = false;
            StateHasChanged();

            var success = await ProcurementService.UpdateOrderStatusAsync(orderToUpdate.OrderId, targetStatus);

            if (success)
            {
                await LoadData();

                if (targetStatus == "Delivered")
                {
                    await ShowToast("success", "Order Delivered!", "Items have been added to inventory automatically.");
                }
                else if (targetStatus == "Cancelled")
                {
                    await ShowToast("warning", "Order Cancelled", "The purchase order has been cancelled.");
                }
                else
                {
                    await ShowToast("info", "Status Updated", $"Order status changed to {targetStatus}.");
                }
            }

            orderToUpdate = null;
            targetStatus = string.Empty;
        }
    }

    // NEW: Helper methods for confirmation modal styling
    private string GetConfirmationHeaderClass(string status)
    {
        return status switch
        {
            "Approved" => "bg-success",
            "Ordered" => "bg-primary",
            "Delivered" => "bg-info",
            "Cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetConfirmationAlertClass(string status)
    {
        return status switch
        {
            "Approved" => "alert-success",
            "Ordered" => "alert-primary",
            "Delivered" => "alert-info",
            "Cancelled" => "alert-danger",
            _ => "alert-secondary"
        };
    }

    private string GetConfirmationButtonClass(string status)
    {
        return status switch
        {
            "Approved" => "btn-success",
            "Ordered" => "btn-primary",
            "Delivered" => "btn-info",
            "Cancelled" => "btn-danger",
            _ => "btn-secondary"
        };
    }

    private string GetConfirmationIcon(string status)
    {
        return status switch
        {
            "Approved" => "✅",
            "Ordered" => "📦",
            "Delivered" => "🚚",
            "Cancelled" => "❌",
            _ => "⚠️"
        };
    }

    private void CancelForm()
    {
        showCreateForm = false;
        selectedSupplierId = 0;
        selectedSupplierName = string.Empty;
        orderItems = new();
        supplierItems = new();
        StateHasChanged();
    }

    private void OnStatusFilterChanged(ChangeEventArgs e)
    {
        filterStatus = e?.Value?.ToString() ?? string.Empty;
        ApplyFilters();
    }

    private void ViewOrderDetails(PurchaseOrder order)
    {
        selectedOrder = order;
        showDetailsModal = true;
        StateHasChanged();
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedOrder = null;
        StateHasChanged();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning text-dark",
            "Approved" => "bg-info",
            "Ordered" => "bg-primary",
            "Delivered" => "bg-success",
            "Cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private async Task ShowToast(string type, string title, string message)
    {
        var toastType = type switch
        {
            "success" => "success",
            "error" => "danger",
            "info" => "info",
            "warning" => "warning",
            _ => "info"
        };

        await JSRuntime.InvokeVoidAsync("showToast", toastType, title, message);
    }

    // NEW: Apply all filters
    private void ApplyFilters()
    {
        var filtered = allOrders.AsEnumerable();

        // Filter by status
        // Filter by status
        if (!string.IsNullOrEmpty(filterStatus) && filterStatus != "All")
        {
            filtered = filtered.Where(o => o.Status == filterStatus);
        }

        // Filter by created date
        if (filterCreatedDate.HasValue)
        {
            filtered = filtered.Where(o => o.CreatedDate.Date == filterCreatedDate.Value.Date);
        }

        // Filter by delivered date
        if (filterDeliveredDate.HasValue)
        {
            filtered = filtered.Where(o =>
                o.DeliveredDate.HasValue &&
                o.DeliveredDate.Value.Date == filterDeliveredDate.Value.Date
            );
        }

        // Filter by search text
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            filtered = filtered.Where(o =>
                o.OrderNumber.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (o.Supplier?.SupplierName ?? "").Contains(searchText, StringComparison.OrdinalIgnoreCase)
            );
        }

        displayedOrders = filtered.ToList();
        StateHasChanged();
    }

    // NEW: Clear all filters
    private void ClearFilters()
    {
        filterStatus = "All";
        filterCreatedDate = null;
        filterDeliveredDate = null;
        searchText = string.Empty;
        ApplyFilters();
    }        
}
